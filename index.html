
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DarkSet ‚Äî V4.7.5</title>
  <meta name="theme-color" content="#0b0b0b"/>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-512.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    tailwind.config = { theme: { extend: {
      colors:{ bgDark:"#0b0b0b", cardDark:"#121212", cardSoft:"#181818", textMain:"#f1f1f1", textSub:"#a3a3a3", borderDark:"#2a2a2a", accent:"#e31b23", accent2:"#ff4d4f"}
    }}};
  </script>
  <style>
    /* Ocultar barra de rolagem horizontal (mobile/desktop) mantendo o scroll */
    nav.ds-nav{ overflow-x:auto; -webkit-overflow-scrolling: touch; gap:.5rem; scrollbar-width: none; }
    nav.ds-nav::-webkit-scrollbar{ display:none; }
    header.ds-hdr{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap; }
    @media (max-width: 480px){ nav.ds-nav button{ flex:0 0 auto } }
    .modal-bg{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:50 }
      /* New UI polish */
    :root{ --ds-radius: 18px; }
    header.ds-hdr{ position: sticky; top: 0; z-index: 30; backdrop-filter: blur(8px); background: rgba(11,11,11,.72); border-bottom: 1px solid rgba(255,255,255,.04); padding: .6rem .5rem; border-radius: 0 0 16px 16px;}
    .ds-card{ border-radius: var(--ds-radius); background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)); border: 1px solid var(--tw-prose-borders, #2a2a2a); box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02); }
    .ds-btn{ border-radius: 14px; padding: .65rem 1rem; font-weight: 600; }
    .ds-btn-primary{ background: linear-gradient(180deg, #e31b23, #b31217); border: 1px solid #8f0f13; color: #fff; }
    .ds-btn-primary:active{ transform: translateY(1px); }
    .ds-btn-ghost{ background: rgba(255,255,255,.06); border: 1px solid #2a2a2a; }
    .ds-shadow{ box-shadow: 0 8px 24px rgba(0,0,0,.35); }
    .safe-pb{ padding-bottom: max(env(safe-area-inset-bottom), 16px); }
    .safe-pt{ padding-top: max(env(safe-area-inset-top), 8px); }
    @media (max-width: 480px){
      .grid-cols-mobile-1{ grid-template-columns: 1fr; }
    }

  
    /* Social sign-in buttons (white, with logo on the left and centered text) */
    .ds-btn-social{ display:inline-flex; align-items:center; justify-content:center; gap:.6rem; border-radius:12px; border:1px solid #2a2a2a; background:#ffffff; color:#111; font-weight:700; padding:.7rem 1rem; box-shadow:0 1px 0 rgba(0,0,0,.35), 0 6px 20px rgba(0,0,0,.25); }
    .ds-btn-social:active{ transform:translateY(1px); }
    .ds-btn-social .ds-icon{ display:inline-flex; width:18px; height:18px; }
    .ds-btn-social .ds-icon svg{ width:18px; height:18px; display:block; }

</style>

<style>
  /* Unified 'Entrar' button style (matches popup primary) */
  .ds-enter{display:inline-flex;align-items:center;justify-content:center;background:#6e5bff;border:1px solid #7b6cff;color:#fff;border-radius:10px;padding:10px 12px;font-weight:700}
</style>

</head>
<body class="bg-bgDark text-textMain min-h-screen overflow-x-hidden">
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useMemo,useRef} = React;

const LS={plans:"darkset.v3.plans",history:"darkset.v3.history",filters:"darkset.v3.filters",prefs:"darkset.v3.prefs"};
const load=(k,fb)=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):fb}catch(e){return fb}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const DAYS=["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];

// ---------- Data (88+ com ajustes de taxonomia) ----------
let exid=1;
const E=(name,primary,subgroup,equipment,difficulty="intermedi√°rio")=>({id:exid++,name,primary,subgroup,equipment,difficulty,media:{type:"gif",srcGif:null,thumb:null}});
const EXS=[
  // Peito
  E("Supino reto barra","Peito","Peitoral Medial","Barra"),
  E("Supino reto halteres","Peito","Peitoral Medial","Halteres"),
  E("Supino inclinado barra","Peito","Peitoral Superior","Barra"),
  E("Supino inclinado com halter","Peito","Peitoral Superior","Halteres"),
  E("Supino inclinado m√°quina","Peito","Peitoral Superior","M√°quina","iniciante"),
  E("Crossover polia alta","Peito","Peitoral Inferior","Cabo/Crossover"),
  E("Crucifixo reto halteres","Peito","Peitoral Medial","Halteres","iniciante"),
  E("Crucifixo inclinado halteres","Peito","Peitoral Superior","Halteres","iniciante"),
  E("Crucifixo M√°quina","Peito","Peitoral Medial","M√°quina","iniciante"),

  // Ombro
  E("Desenvolvimento barra","Ombro","Frontal","Barra"),
  E("Desenvolvimento halter","Ombro","Frontal","Halteres"),
  E("Desenvolvimento m√°quina","Ombro","Frontal","M√°quina","iniciante"),
  E("Eleva√ß√£o lateral halter","Ombro","Lateral","Halteres","iniciante"),
  E("Eleva√ß√£o lateral polia","Ombro","Lateral","Cabo/Crossover","iniciante"),
  E("Eleva√ß√£o frontal halteres","Ombro","Frontal","Halteres","iniciante"),
  E("Face Pull (corda)","Ombro","Posterior","Cabo/Crossover","iniciante"),
  E("Crucifixo inverso m√°quina","Ombro","Posterior","M√°quina","iniciante"),
  E("Crucifixo inverso polia","Ombro","Posterior","Cabo/Crossover","iniciante"),
  // Trap√©zio Superior (sem subgrupo "trap√©zio" extra)
  E("Remada Alta Barra","Trap√©zio","Superior","Barra"),

  // Trap√©zio isolado
  E("Encolhimento Barra","Trap√©zio","Superior","Barra","iniciante"),
  E("Encolhimento Halteres","Trap√©zio","Superior","Halteres","iniciante"),

  // Costas
  E("Barra fixa","Costas","Dorsal (Lats)","Peso corporal","avan√ßado"),
  E("Remada curvada barra","Costas","Romboides/Trap√©zio M√©dio","Barra"),
  E("Remada Articulada","Costas","Romboides/Trap√©zio M√©dio","M√°quina"),
  E("Puxada alta unilateral","Costas","Dorsal (Lats)","Cabo/Crossover"),
  E("Remada baixa polia","Costas","Romboides/Trap√©zio M√©dio","Cabo/Crossover"),
  E("Remada baixa aberta polia","Costas","Romboides/Trap√©zio M√©dio","Cabo/Crossover"),
  E("Puxada aberta polia alta","Costas","Dorsal (Lats)","Cabo/Crossover"),
  E("Puxada tri√¢ngulo","Costas","Dorsal (Lats)","Cabo/Crossover"),
  E("Pulldown","Costas","Dorsal (Lats)","Cabo/Crossover","iniciante"),
  E("Remada baixa unilateral","Costas","Romboides/Trap√©zio M√©dio","Cabo/Crossover"),
  E("Remada cavalinho","Costas","Romboides/Trap√©zio M√©dio","Barra"),
  E("Hiperextens√£o lombar","Lombar","Lombar","Peso corporal","iniciante"),

  // B√≠ceps
  E("Rosca direta barra","B√≠ceps","B√≠ceps Braquial","Barra"),
  E("Rosca direta halteres","B√≠ceps","B√≠ceps Braquial","Halteres"),
  E("Rosca alternada halter","B√≠ceps","B√≠ceps Braquial","Halteres"),
  E("Rosca alternada sentada","B√≠ceps","B√≠ceps Braquial","Halteres"),
  E("Rosca martelo halteres","B√≠ceps","Braquiorradial","Halteres"),
  E("Rosca martelo corda","B√≠ceps","Braquiorradial","Cabo/Crossover"),
  E("Rosca Scott m√°quina","B√≠ceps","B√≠ceps Braquial","M√°quina","iniciante"),
  E("Rosca 45¬∞","B√≠ceps","B√≠ceps Braquial","Halteres"),

  // Tr√≠ceps
  E("Tr√≠ceps testa barra W","Tr√≠ceps","Cabe√ßa Longa","Barra"),
  E("Tr√≠ceps testa halter","Tr√≠ceps","Cabe√ßa Longa","Halteres"),
  E("Tr√≠ceps Franc√™s halter","Tr√≠ceps","Cabe√ßa Longa","Halteres"),
  E("Tr√≠ceps Franc√™s polia","Tr√≠ceps","Cabe√ßa Longa","Cabo/Crossover"),
  E("Tr√≠ceps pulley corda","Tr√≠ceps","Cabe√ßa Lateral","Cabo/Crossover","iniciante"),
  E("Mergulho no banco","Tr√≠ceps","Paralelas","Peso corporal","iniciante"),

  // Quadr√≠ceps (sem subgrupos)
  E("Agachamento livre","Quadr√≠ceps","", "Barra","avan√ßado"),
  E("Agachamento sum√¥ halteres","Quadr√≠ceps","", "Halteres"),
  E("Agachamento b√∫lgaro","Quadr√≠ceps","", "Halteres","avan√ßado"),
  E("Leg press 45¬∞","Quadr√≠ceps","", "M√°quina"),
  E("Leg 180¬∞ unilateral","Quadr√≠ceps","", "M√°quina"),
  E("Cadeira extensora","Quadr√≠ceps","", "M√°quina","iniciante"),
  E("Passada avan√ßada halteres","Quadr√≠ceps","", "Halteres"),

  // Posterior de Coxa (sem subgrupos)
  E("Mesa flexora","Posterior de Coxa","", "M√°quina","iniciante"),
  E("Mesa flexora deitada","Posterior de Coxa","", "M√°quina","iniciante"),
  E("Cadeira flexora","Posterior de Coxa","", "M√°quina","iniciante"),
  E("Cadeira flexora unilateral","Posterior de Coxa","", "M√°quina"),
  E("Flexora unilateral em p√©","Posterior de Coxa","", "M√°quina"),
  E("Stiff","Posterior de Coxa","", "Barra"),
  E("Stiff com halteres","Posterior de Coxa","", "Halteres"),

  // Gl√∫teo (com por√ß√µes)
  E("Eleva√ß√£o p√©lvica com barra","Gl√∫teo","Gl√∫teo M√°ximo","Barra"),
  E("Extens√£o de quadril no cabo","Gl√∫teo","Gl√∫teo M√°ximo","Cabo/Crossover","iniciante"),
  E("Gl√∫teo Crossover Polia","Gl√∫teo","Gl√∫teo M√°ximo","Cabo/Crossover","iniciante"),

  // Panturrilha
  E("Panturrilha em p√© maquina","Panturrilha","Gastrocn√™mio","M√°quina","iniciante"),
  E("Panturrilha sentado m√°quina","Panturrilha","S√≥leo","M√°quina","iniciante"),
  E("Panturrilha em p√© barra livre","Panturrilha","Gastrocn√™mio","Barra","iniciante"),

  // Abdutores / Adutores (m√∫sculos separados)
  E("Cadeira abdutora","Abdutores","Geral","M√°quina","iniciante"),
  E("Cadeira adutora","Adutores","Geral","M√°quina","iniciante"),

  // Abd√¥men
  E("Abd√¥men infra","Abd√¥men","Infra","Peso corporal","iniciante"),
  E("Abd√¥men supra","Abd√¥men","Supra","Peso corporal","iniciante"),
  E("Prancha isom√©trica","Abd√¥men","Est√°tico","Peso corporal","iniciante"),

  // Antebra√ßo
  E("Rosca inversa barra","Antebra√ßo","Extensores","Barra","iniciante"),
  E("Rosca punho barra","Antebra√ßo","Flexores","Barra","iniciante"),
];
// --- Demo media for 3 exercises (GIF-only) ---
(()=>{
  const byName = (n)=> EXS.find(e=> e.name===n);
  const setGif=(n, gif)=>{
    const ex = byName(n); if(!ex) return;
    ex.media = { type:"gif", srcGif: gif, thumb: null };
  };
  setGif("Supino reto barra", "/gifs/supino_reto_barra.gif"); // Peito
  setGif("Remada curvada barra", "/gifs/remada_curvada_barra.gif"); // Costas
  setGif("Agachamento livre", "/gifs/agachamento_livre.gif"); // Perna
})();

// Filters
const MUSCLES=[...new Set(EXS.map(e=>e.primary))];
const SUBS_BY = MUSCLES.reduce((acc,m)=>{acc[m]=[...new Set(EXS.filter(e=>e.primary===m && e.subgroup).map(e=>e.subgroup))];return acc;},{});
const EQUIPS=[...new Set(EXS.map(e=>e.equipment))];
const DIFFS=[...new Set(EXS.map(e=>e.difficulty))];

function usePlans(){
  const [plans,setPlans]=useState(()=>load(LS.plans,{activeId:null,list:[]}));
  useEffect(()=>save(LS.plans,plans),[plans]);
  return [plans,setPlans];
}
function useHistory(){
  const [history,setHistory]=useState(()=>load(LS.history,{}));
  useEffect(()=>save(LS.history,history),[history]);
  return [history,setHistory];
}
function usePrefs(){
  const [prefs,setPrefs]=useState(()=>load(LS.prefs,{name:"",avatar:"üíÄ",unit:"kg",vibrate:true,weeklyGoal:5,showTimer:true,timerPreset:60,rirDefault:2,chartsPremium:false}));
  useEffect(()=>save(LS.prefs,prefs),[prefs]);
  return [prefs,setPrefs];
}

const Card=({title,children,footer})=>(
  <div className="ds-card rounded-2xl p-4 border border-borderDark">
    {title && <div className="font-semibold text-lg mb-2">{title}</div>}
    <div>{children}</div>
    {footer && <div className="mt-3 pt-3 border-t border-borderDark text-sm text-textSub">{footer}</div>}
  </div>
);
const Button=({children,onClick,variant="default",disabled,full=false})=>{
  const cls={
    default:"ds-btn ds-btn-ghost",
    ghost:"ds-btn ds-btn-ghost",
    danger:"ds-btn ds-btn-ghost border-red-700 bg-red-600/80 text-white",
    success:"ds-btn ds-btn-ghost border-green-700 bg-green-600/80 text-white",
    accent:"ds-btn ds-btn-primary"
  }[variant];
  return <button className={cls+(disabled?" opacity-60":"")+(full?" w-full justify-center text-center":"")} onClick={onClick} disabled={disabled}>{children}</button>;
};
const Switch=({checked,onChange})=>(
  <label className="inline-flex items-center cursor-pointer">
    <input type="checkbox" className="sr-only" checked={checked} onChange={e=>onChange(e.target.checked)}/>
    <div className={"w-10 h-6 rounded-full "+(checked?"bg-accent":"bg-zinc-700")}>
      <div className={"w-5 h-5 bg-white rounded-full mt-0.5 ml-0.5 transition-transform "+(checked?"translate-x-4":"")}></div>
    </div>
  </label>
);
const LockIcon=({className=""})=> (
  <svg className={className} width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M7 10V8a5 5 0 1 1 10 0v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <rect x="5" y="10" width="14" height="10" rx="2" stroke="currentColor" strokeWidth="2"/>
    <circle cx="12" cy="15" r="1.5" fill="currentColor"/>
  </svg>
);


const LogoRow=({name})=> (
  <div className="flex items-center gap-3">
    <img src="icons/icon-512.png" width="40" height="40" className="rounded-2xl shadow" style={{filter:'drop-shadow(0 0 6px rgba(227,27,35,.45))'}}/>
    <div>
      <div className="text-2xl font-black"><span>Dark</span><span className="text-textSub">Set</span></div>
      <div className="text-xs text-textSub -mt-1">Seu treino, sua evolu√ß√£o</div>
    </div>
  </div>
);

// Toast
const Toast=({text})=> <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-white/10 border border-borderDark px-4 py-2 rounded-xl">{text}</div>;

// Modal
const Modal=({onClose,children})=>(
  <div className="modal-bg" onClick={onClose}>
    <div className="bg-cardDark border border-borderDark rounded-2xl p-4 max-w-md w-[92%]" onClick={e=>e.stopPropagation()}>
      {children}
    </div>
  </div>
);


// Play Icon
const PlayIcon=({className=""})=>(
  <svg className={className} width="28" height="28" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
    <path d="M8 5v14l11-7-11-7z"/>
  </svg>
);
// Exercise Preview Box (16:9 with play overlay)
const PreviewBox=({label="Execu√ß√£o do exerc√≠cio", onClick, disabled})=>{
  return (
    <div className={"relative w-full rounded-2xl border border-borderDark overflow-hidden "+(disabled?"opacity-60":"")}>
      <div className="pt-[56.25%] bg-black/30"></div>
      <button
        onClick={onClick}
        disabled={disabled}
        className="absolute inset-0 flex flex-col items-center justify-center gap-1 text-textSub hover:bg-white/5 transition"
      >
        <div className="rounded-full p-2 bg-white/10 border border-borderDark">
          <PlayIcon/>
        </div>
        <div className="text-xs">{label}</div>
      </button>
    </div>
  );
};
// Home
const Home=({goto,plans,history,prefs})=>{
  const [authUser,setAuthUser]=useState(()=>{ try{return JSON.parse(localStorage.getItem('darkset.user'));}catch(_){return null;} });
  useEffect(()=>{ const id=setInterval(()=>{ try{ setAuthUser(JSON.parse(localStorage.getItem('darkset.user'))); }catch(_){} }, 800); return ()=>clearInterval(id); },[]);

  const active=plans.list.find(p=>p.id===plans.activeId)||null;
  const entries=Object.entries(history);
  const thisWeek=(()=>{const now=new Date();const start=new Date(now);start.setDate(now.getDate()-now.getDay()+1);return entries.filter(([iso])=>new Date(iso)>=start).length;})();
  return (
    <div className="grid gap-4">
      <Card>
        <div className="flex items-center justify-between"><LogoRow/><div className="text-sm text-textSub">Semana: <b>{thisWeek}</b> / {prefs.weeklyGoal} treinos</div></div>
      </Card>
      <div className="grid grid-cols-3 gap-3 max-md:grid-cols-1">
        <Button onClick={()=>goto('plans')} variant="ghost">Fichas</Button>
        <Button onClick={()=>goto('session')} variant="accent">Modo Treino</Button>
        <Button onClick={()=>goto('history')} variant="ghost">Hist√≥rico</Button>
      </div>
      <Card title="Ficha ativa">
        {active? (<div className="flex items-center justify-between"><div className="font-medium">{active.name}</div><Button onClick={()=>goto('builder',active.id)} variant="ghost">Editar</Button></div>)
        :(<div className="flex items-center justify-between"><div className="text-textSub">Nenhuma ficha ativa.</div><Button onClick={()=>goto('plans')} variant="ghost">Criar agora</Button></div>)}
      </Card>
      <Card title={authUser ? "Perfil r√°pido" : "Acesso"}>
  {authUser ? (<div className="flex items-center justify-between">
      <div className="flex items-center gap-2">
        <div className="text-2xl">{prefs.avatar}</div>
        <div className="text-sm text-textSub">{prefs.name || "Sem nome"}</div>
      </div>
      <Button onClick={()=>goto('profile')} variant="ghost">Editar perfil</Button>
    </div>
  ) : (
    <div className="flex items-center justify-between flex-wrap gap-2">
      <div className="text-sm text-textSub">Entre para salvar seu progresso na nuvem.</div>
      <div className="flex gap-2 w-full sm:w-auto justify-end">
        <Button full variant="accent" onClick={()=>goto('profile')}>Entrar</Button>
        <Button full variant="ghost" onClick={()=>goto('profile')}>Criar conta</Button>
      </div>
    </div>
  )}
</Card>
    </div>
  );
};

// Plans
const Plans=({plans,setPlans,goto,setToast})=>{
  const [renameId,setRenameId]=useState(null);
  const [newName,setNewName]=useState("");
  const [sharePlan,setSharePlan]=useState(null);

  const createPlan=()=>{ if(!newName.trim()) return; const id=Date.now(); const byDay={}; for(const d of DAYS){byDay[d]=[]} setPlans(p=>({...p,list:[...p.list,{id,name:newName.trim(),byDay}],activeId:p.activeId||id})); setNewName(""); };
  const duplicatePlan=(id)=> setPlans(p=>{const src=p.list.find(x=>x.id===id);const clone=JSON.parse(JSON.stringify(src));clone.id=Date.now();clone.name=src.name+" (c√≥pia)";return {...p,list:[...p.list,clone]};});
  const removePlan=(id)=> setPlans(p=>({...p,list:p.list.filter(pl=>pl.id!==id),activeId:p.activeId===id?null:p.activeId}));
  const activate=(id,val)=> setPlans(p=>({...p,activeId:val? id: (p.activeId===id? null:p.activeId)}));

  const openShare=(pl)=> setSharePlan(pl);
  const closeShare=()=> setSharePlan(null);

  // generate import link
  const makeImportLink=(pl)=>{
    const payload = { name: pl.name, byDay: pl.byDay };
    const raw = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(payload)))));
    return `${location.origin}${location.pathname}?import=${raw}`;
  };

  useEffect(()=>{
    if(!sharePlan) return;
    // render QR
    setTimeout(()=>{
      const el = document.getElementById("qr-box");
      if(el){ el.innerHTML=""; new QRCode(el, { text: makeImportLink(sharePlan), width: 196, height: 196 }); }
    },10);
  },[sharePlan]);

  return (
    <div className="grid gap-4">
      <Card title="Minhas fichas">
        <div className="space-y-2">
          {plans.list.length===0 && <div className="text-sm text-textSub">Nenhuma ficha criada.</div>}
          {plans.list.map(pl=>(
            <div key={pl.id} className="flex flex-col md:flex-row md:items-center md:justify-between border border-borderDark rounded-xl p-3 gap-2">
              <div className="flex items-center gap-3">
                <Switch checked={plans.activeId===pl.id} onChange={(v)=>activate(pl.id,v)}/>
                {renameId===pl.id? (
                  <input className="border border-borderDark bg-black/30 rounded px-2 py-1" value={pl.name} onChange={e=> setPlans(p=>({...p,list:p.list.map(x=>x.id===pl.id? {...x,name:e.target.value}:x)}))}/>
                ) : (<div className="font-medium">{pl.name}</div>)}
              </div>
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 w-full md:w-auto">
                {renameId===pl.id? <Button full variant="success" onClick={()=>setRenameId(null)}>Ok</Button> : <Button full variant="ghost" onClick={()=>setRenameId(pl.id)}>Renomear</Button>}
                <Button full variant="ghost" onClick={()=>duplicatePlan(pl.id)}>Duplicar</Button>
                <Button full variant="ghost" onClick={()=>openShare(pl)}>Compartilhar</Button>
                <Button full variant="danger" onClick={()=>{ if(confirm("Excluir esta ficha? O hist√≥rico n√£o ser√° apagado.")) { removePlan(pl.id); setToast("Ficha exclu√≠da"); } }}>Excluir</Button>
                <Button full onClick={()=>goto('viewer',pl.id)} variant="ghost">Visualizar</Button>
                <Button full onClick={()=>goto('builder',pl.id)}>Editar</Button>
              </div>
            </div>
          ))}
        </div>
      </Card>
      <Card title="Criar nova ficha">
        <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 w-full md:w-auto">
          <input className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 flex-1" placeholder="Ex.: Foco em Peito" value={newName} onChange={e=>setNewName(e.target.value)}/>
          <Button full variant="accent" onClick={createPlan}>Criar</Button>
        </div>
      </Card>

      {sharePlan && (
        <Modal onClose={closeShare}>
          <div className="font-semibold text-lg mb-2">Compartilhar: {sharePlan.name}</div>
          <div id="qr-box" className="mx-auto my-2 w-[196px] h-[196px] border border-borderDark rounded-xl"></div>
          <div className="text-xs text-textSub mb-2">Escaneie o QR ou copie o link abaixo:</div>
          <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 w-full md:w-auto">
            <input id="share-link" className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full text-xs" readOnly value={makeImportLink(sharePlan)}/>
            <Button full variant="ghost" onClick={()=>{ const el=document.getElementById('share-link'); el.select(); document.execCommand('copy'); setToast("Link copiado"); }}>Copiar</Button>
          </div>
          <div className="text-xs text-textSub mt-2">O link cont√©m somente a estrutura da ficha. Hist√≥rico e dados pessoais n√£o s√£o enviados.</div>
          <div className="mt-3 text-right"><Button full variant="ghost" onClick={closeShare}>Fechar</Button></div>
        </Modal>
      )}
    </div>
  );
};

// Builder
const Builder=({planId,plans,setPlans,setToast})=>{
  const plan=plans.list.find(p=>p.id===planId)||plans.list[0];
  const [day,setDay]=useState(DAYS[0]);
  const [filters,setFilters]=useState(()=>load(LS.filters,{q:"",m:"",s:"",e:"",d:""}));
  const {q,m,s,e,d} = filters;
  const [videoEx,setVideoEx] = useState(null); // (n√£o usado neste modo)
  const [openInline, setOpenInline] = useState({}); // exId => bool
  const openVideo=(exMeta)=>{
    if(!exMeta) return;
    setOpenInline(prev=> ({...prev, [exMeta.id]: !prev[exMeta.id]}));
  };


  useEffect(()=>save(LS.filters,filters),[filters]);

  const list=useMemo(()=> EXS.filter(ex=>{
    const nameOk=ex.name.toLowerCase().includes(q.toLowerCase());
    const mOk=!m||ex.primary===m;
    const sOk=!s||ex.subgroup===s;
    const eOk=!e||ex.equipment===e;
    const dOk=!d||ex.difficulty===d;
    return nameOk && mOk && sOk && eOk && dOk;
  }),[q,m,s,e,d]);

  const dayItems=plan?.byDay?.[day]||[];
  const canAdd=(ex)=> !dayItems.some(it=>it.exId===ex.id);
  const addEx=(ex,setsPlanned)=>{
    setPlans(p=>{
      const copy=JSON.parse(JSON.stringify(p));
      const pl=copy.list.find(x=>x.id===plan.id);
      const arr=pl.byDay[day];
      if(arr.some(it=>it.exId===ex.id)) return p;
      arr.push({exId:ex.id,name:ex.name,setsPlanned:Math.max(1,Number(setsPlanned)||3)});
      return copy;
    });
    setToast("‚úÖ Adicionado");
  };
  const removeItem=(i)=> setPlans(p=>{const copy=JSON.parse(JSON.stringify(p));const arr=copy.list.find(x=>x.id===plan.id).byDay[day];arr.splice(i,1);return copy;});
  const move=(i,dir)=> setPlans(p=>{const copy=JSON.parse(JSON.stringify(p));const arr=copy.list.find(x=>x.id===plan.id).byDay[day];const j=i+dir;if(j<0||j>=arr.length)return p;[arr[i],arr[j]]=[arr[j],arr[i]];return copy;});

  const MUSCLES=[...new Set(EXS.map(e=>e.primary))];
  const SUBS_BY = MUSCLES.reduce((acc,m)=>{acc[m]=[...new Set(EXS.filter(e=>e.primary===m && e.subgroup).map(e=>e.subgroup))];return acc;},{});
  const EQUIPS=[...new Set(EXS.map(e=>e.equipment))];
  const DIFFS=[...new Set(EXS.map(e=>e.difficulty))];

  return (
    <div className="grid gap-4">
      <Card title={"Editando: "+(plan?.name||"Ficha")}>
        <div className="flex gap-2 flex-wrap mb-3">{DAYS.map(dy=>(<button key={dy} onClick={()=>setDay(dy)} className={"px-3 py-1.5 rounded-full border border-borderDark "+(day===dy?"bg-white/10":"")}>{dy}</button>))}</div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
          <div className="rounded-2xl border border-borderDark p-3">
            <div className="font-medium mb-2">Procurar</div>
            <input className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full mb-2" placeholder="Buscar por nome‚Ä¶" value={q} onChange={e=>setFilters({...filters,q:e.target.value})}/>
            <div className="grid grid-cols-2 gap-2 mb-2">
              <select className="border border-borderDark bg-black/30 rounded-xl px-2 py-2 text-sm" value={m} onChange={e=>{const v=e.target.value; setFilters({...filters,m:v,s:""});}}>
                <option value="">M√∫sculo</option>{MUSCLES.map(x=><option key={x}>{x}</option>)}
              </select>
              <select className="border border-borderDark bg-black/30 rounded-xl px-2 py-2 text-sm" value={s} onChange={e=>setFilters({...filters,s:e.target.value})} disabled={!m || (SUBS_BY[m]||[]).length===0}>
                <option value="">Subgrupo</option>{(m? SUBS_BY[m]:[]).map(x=><option key={x}>{x}</option>)}
              </select>
              <select className="border border-borderDark bg-black/30 rounded-xl px-2 py-2 text-sm" value={e} onChange={e2=>setFilters({...filters,e:e2.target.value})}>
                <option value="">Equipamento</option>{EQUIPS.map(x=><option key={x}>{x}</option>)}
              </select>
              <select className="border border-borderDark bg-black/30 rounded-xl px-2 py-2 text-sm" value={d} onChange={e3=>setFilters({...filters,d:e3.target.value})}>
                <option value="">Dificuldade</option>{DIFFS.map(x=><option key={x}>{x}</option>)}
              </select>
            </div>
            <div className="space-y-2 max-h-80 overflow-auto pr-1">
              {list.map(ex=>(
                <div key={ex.id} className="flex flex-col sm:flex-row items-center gap-3 border border-borderDark rounded-xl p-3">
                  <div className="w-full sm:w-28">
                    {ex.media?.srcGif ? (
                      <div className="relative w-full rounded-2xl overflow-hidden border border-borderDark bg-black">
                        <img src={ex.media.srcGif} alt={ex.name} className="w-full h-auto"/>
                      </div>
                    ) : (
                      <div className="relative w-full rounded-2xl border border-borderDark overflow-hidden">
                        <div className="pt-[56.25%] bg-black/30"></div>
                        <div className="absolute inset-0 flex items-center justify-center text-textSub text-xs">Pr√©via</div>
                      </div>
                    )}
                  </div>
                  <div className="flex-1 w-full">
                    <div className="font-medium break-words">{ex.name}</div>
                    <div className="text-xs text-textSub">{ex.primary} ‚Ä¢ {ex.subgroup||"‚Äî"} ‚Ä¢ {ex.equipment} ‚Ä¢ {ex.difficulty}</div>
                  </div>
                  <div className="flex items-center gap-2 w-full sm:w-auto justify-between sm:justify-end">
                    <label className="text-xs text-textSub">S√©ries</label>
                    <input type="number" min="1" max="10" defaultValue="3" className="border border-borderDark bg-black/30 rounded-xl w-16 px-2 py-1 text-sm"/>
                    <Button variant="ghost" onClick={(ev)=>{const sets=ev.target.parentElement.querySelector('input').value; if(canAdd(ex)){ addEx(ex,sets);} }} disabled={!canAdd(ex)}>Adicionar</Button>
                  </div>
                </div>
              ))}
              {list.length===0 && <div className="text-sm text-textSub">Nenhum exerc√≠cio encontrado para os filtros.</div>}
            </div>
          </div>

          <div className="rounded-2xl border border-borderDark p-3">
            <div className="font-medium mb-2">Exerc√≠cios de {day}</div>
            {dayItems.length===0 ? <div className="text-sm text-textSub">Nenhum exerc√≠cio adicionado.</div> : (
              <div className="space-y-2">
                {dayItems.map((it,i)=>(
                  <div key={i} className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 border border-borderDark rounded-xl p-2">
                    <div className="flex-1 min-w-0">
                      <div className="font-medium break-words">{it.name}</div>
                      <div className="text-xs text-textSub">S√©ries: {it.setsPlanned}</div>
                    </div>
                    <div className="flex flex-wrap gap-2 w-full sm:w-auto justify-between sm:justify-end">
                      <Button variant="ghost" onClick={()=>move(i,-1)}>‚Üë</Button>
                      <Button variant="ghost" onClick={()=>move(i,1)}>‚Üì</Button>
                      <Button variant="ghost" onClick={()=>removeItem(i)}>Remover</Button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </Card>
      {false && videoEx && (
        <Modal onClose={()=>setVideoEx(null)}>
          <div className="flex items-start justify-between mb-2">
            <div>
              <div className="text-sm text-textSub">Execu√ß√£o do exerc√≠cio</div>
              <div className="font-semibold">{videoEx.name}</div>
            </div>
            <Button variant="ghost" onClick={()=>setVideoEx(null)}>Fechar</Button>
          </div>
          {videoEx.media ? (
            <div className="rounded-xl overflow-hidden border border-borderDark bg-black">
              <img src={videoEx.media?.srcGif} alt={videoEx.name} className="w-full h-auto" />
            </div>
          ) : (
            <div className="text-sm text-textSub">Pr√©via ainda n√£o dispon√≠vel para este exerc√≠cio.</div>
          )}
        </Modal>
      )}
    </div>
  );
}
// Viewer (Visualizador de Ficha) ‚Äî GIF-only popup
const Viewer = ({planId, plans, goto}) => {
  const plan = plans.list.find(p => p.id === planId) || plans.list[0] || null;
  const [day, setDay] = React.useState(DAYS[0]);
  const [videoEx, setVideoEx] = React.useState(null);

  if (!plan) {
    return <Card title="Visualizar ficha"><div className="text-sm text-textSub">Nenhuma ficha ativa. Crie/ative uma ficha primeiro.</div></Card>;
  }

  const items = plan.byDay?.[day] || [];
  const openVideo = (ex) => {
    const meta = EXS.find(e => e.id === ex.exId) || EXS.find(e => e.name === ex.name);
    if (meta && meta.media?.srcGif) {
      setVideoEx(meta);
    } else {
      setVideoEx({ name: ex.name, media: null }); // sem preview
    }
  };

  return (
    <div className="grid gap-4">
      <Card title={"Visualizando: " + (plan?.name || "Ficha")}>
        <div className="flex items-center justify-between mb-3">
          <div className="flex gap-2 flex-wrap">
            {DAYS.map(dy => (
              <button key={dy} onClick={() => setDay(dy)} className={"px-3 py-1.5 rounded-full border border-borderDark " + (day === dy ? "bg-white/10" : "")}>{dy}</button>
            ))}
          </div>
          <Button variant="ghost" onClick={() => goto('plans')}>Voltar</Button>
        </div>

        {items.length === 0 ? (
          <div className="text-sm text-textSub">Nenhum exerc√≠cio para {day}.</div>
        ) : (
          <div className="space-y-3">
            {items.map((it, i) => {
              const meta = EXS.find(e => e.id === it.exId) || EXS.find(e => e.name === it.name);
              return (
                <div key={i} className="flex flex-col sm:flex-row items-center gap-3 border border-borderDark rounded-xl p-3">
                  <div className="flex-1 w-full">
                    <div className="font-medium break-words">{it.name}</div>
                    <div className="text-xs text-textSub">S√©ries planejadas: {it.setsPlanned || 3}</div>
                  </div>
                  <div className="w-full sm:w-auto">
                    <Button variant="ghost" onClick={() => openVideo(it)}>Execu√ß√£o</Button>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </Card>

      {videoEx && (
        <Modal onClose={() => setVideoEx(null)}>
          <div className="flex items-start justify-between mb-2">
            <div>
              <div className="text-sm text-textSub">Execu√ß√£o do exerc√≠cio</div>
              <div className="font-semibold">{videoEx.name}</div>
            </div>
            <Button variant="ghost" onClick={() => setVideoEx(null)}>Fechar</Button>
          </div>
          {videoEx.media && videoEx.media.srcGif ? (
            <div className="rounded-xl overflow-hidden border border-borderDark bg-black">
              <img src={videoEx.media.srcGif} alt={videoEx.name} className="w-full h-auto" />
            </div>
          ) : (
            <div className="text-sm text-textSub">Pr√©via ainda n√£o dispon√≠vel para este exerc√≠cio.</div>
          )}
        </Modal>
      )}
    </div>
  );
};

;// Session

// DarkTimer ‚Äî V4.4.4 (persistente, sem Wake Lock)
const DarkTimer = ({prefs}) => {
  const STORAGE_KEY = "darkset.timer.v1";
  const [sec,setSec]=useState(Math.max(5, Number(prefs.timerPreset||60)));
  const [running,setRunning]=useState(false);
  const endRef = useRef(0);

  useEffect(()=>{ if(!running){ setSec(Math.max(5, Number(prefs.timerPreset||60))); } }, [prefs.timerPreset]);

  useEffect(()=>{
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const st = JSON.parse(raw);
        if(st.active && st.endTime){
          const remain = Math.ceil((st.endTime - Date.now())/1000);
          if(remain > 0){
            endRef.current = st.endTime;
            setSec(remain);
            setRunning(true);
          }else{
            setSec(Math.max(5, Number(prefs.timerPreset||60)));
            setRunning(false);
            localStorage.removeItem(STORAGE_KEY);
          }
        }else if(typeof st.pausedSec === "number"){
          setSec(Math.max(0, st.pausedSec));
          setRunning(false);
        }
      }
    }catch(_){}
  },[]);

  useEffect(()=>{
    if(!running) return;
    let loop;
    const tick = () => {
      const remainMs = endRef.current - Date.now();
      const remain = Math.max(0, Math.ceil(remainMs/1000));
      if(remain <= 0){
        try{ if(navigator.vibrate) navigator.vibrate([320,140,320,140,420]); }catch(_){}
        try{
          const AC=window.AudioContext||window.webkitAudioContext;
          if(AC){
            const ctx=new AC();
            const g=ctx.createGain(); g.connect(ctx.destination);
            g.gain.setValueAtTime(0.35, ctx.currentTime);
            const mk=(t)=>{ const o=ctx.createOscillator(); o.type="square"; o.frequency.setValueAtTime(700, t); o.connect(g); o.start(t); o.stop(t+0.22); };
            const now=ctx.currentTime; mk(now); mk(now+0.36); mk(now+0.72);
            setTimeout(()=>ctx.close(), 1200);
          }
        }catch(_){}
        setRunning(false);
        setSec(Math.max(5, Number(prefs.timerPreset||60)));
        try{ localStorage.removeItem(STORAGE_KEY); }catch(_){}
      }else{
        setSec(remain);
        const delay = Math.max(150, 1000 - (Date.now() % 1000));
        loop = setTimeout(tick, delay);
      }
    };
    loop = setTimeout(tick, 150);
    return ()=> clearTimeout(loop);
  },[running]);

  const start = () => {
    const duration = Math.max(1, Number(sec||0));
    endRef.current = Date.now() + duration*1000;
    setRunning(true);
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({active:true, endTime:endRef.current})); }catch(_){}
  };
  const pause = () => {
    const remain = Math.max(0, Math.ceil((endRef.current - Date.now())/1000));
    setRunning(false);
    setSec(remain || Math.max(5, Number(prefs.timerPreset||60)));
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({active:false, pausedSec: remain})); }catch(_){}
  };
  const reset = () => {
    setRunning(false);
    setSec(Math.max(5, Number(prefs.timerPreset||60)));
    try{ localStorage.removeItem(STORAGE_KEY); }catch(_){}
  };

  const presets=[30,60,90,120,150,180];
  return (
    <div className="border border-borderDark rounded-2xl p-3 grid gap-2 bg-cardDark/70">
      <div className="flex items-start justify-between gap-3">
        <div className="flex flex-col">
          <div className="font-semibold">DarkTimer</div>
          <div className="text-2xl font-semibold tabular-nums mt-1">{sec}s</div>
        </div>
        <div className="flex gap-2">
          <Button onClick={reset}>Reset</Button>
          <Button variant={running?"danger":"accent"} onClick={()=> running ? pause() : start()}>{running? "Pausar":"Iniciar"}</Button>
        </div>
      </div>
      <div className="flex flex-wrap gap-2">
        {presets.map(p=>(
          <button key={p} onClick={()=>{ if(!running){ setSec(p); try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({active:false, pausedSec:p})); }catch(_){} } }} className={"px-3 py-1.5 rounded-full border border-borderDark "+(sec===p?"bg-white/10":"")}>{p}s</button>
        ))}
      </div>
    </div>
  );
};


const Session=({plans,history,setHistory,prefs,goto,setToast})=>{
  const activePlanId=plans.activeId||(plans.list[0]?.id??null);
  const activePlan=plans.list.find(p=>p.id===activePlanId)||null;
  const [started,setStarted]=useState(false);
  const [day,setDay]=useState(DAYS[(new Date().getDay()||7)-1]);
  const [cursor,setCursor]=useState(0);
  const planItems=activePlan? activePlan.byDay[day]:[];
  const [sets,setSets]=useState([]);
  const [rir,setRir]=useState([]);
  const [savedSnap,setSavedSnap]=useState({});
  const [previewOpen,setPreviewOpen]=useState(false);

  useEffect(()=>{
    if(!started) return;
    const planned=planItems[cursor]?.setsPlanned||3;
    setSets(Array.from({length:planned},()=>({w:"",r:""})));
    const _def = (typeof prefs.rirDefault==="number") ? (prefs.rirDefault===0? "Falha" : String(prefs.rirDefault)) : "--";
    setRir(Array.from({length:planned},()=> _def));
    setSavedSnap({});
  },[cursor,day,started]);

  const start=()=>setStarted(true);
  const back=()=>setStarted(false);

  const snapshot=()=>JSON.stringify({sets,rir});
  const isDirty=!savedSnap[cursor] || savedSnap[cursor]!==snapshot();

  const lastPerf=(()=>{
    const ex=planItems[cursor]; if(!ex) return null;
    const entries=Object.entries(history).sort((a,b)=>a[0]>b[0]?-1:1);
    for(const [,obj] of entries){
      const f=obj.entries.find(e=>e.name===ex.name);
      if(f) return f;
    }
    return null;
  })();

  const saveCurrent=()=>{
    const ex=planItems[cursor]; if(!ex) return;
    const dateKey=new Date().toISOString().slice(0,10);
    setHistory(prev=>{
      const copy={...prev};
      if(!copy[dateKey]) copy[dateKey]={planId:activePlanId, planName:activePlan.name, day, entries:[]};
      const setsOut=sets.map((s,i)=>({w:s.w,r:s.r, ...(rir[i]&&rir[i]!=="--"?{rir:rir[i]}:{})}));
      const idx=copy[dateKey].entries.findIndex(en=>en.name===ex.name);
      if(idx>=0) copy[dateKey].entries[idx].sets=setsOut; else copy[dateKey].entries.push({name:ex.name, exId:ex.exId, sets:setsOut});
      return copy;
    });
    setSavedSnap(m=>({...m,[cursor]:snapshot()}));
    if(prefs.vibrate && navigator.vibrate) navigator.vibrate(20);
    setToast("S√©ries salvas");
  };

  if(!activePlan) return <Card title="Modo Treino"><div className="text-sm text-textSub">Crie e ative uma ficha primeiro.</div></Card>;

  if(!started){
    return (
      <Card title="Modo Treino">
        <div className="grid gap-3">
          <div>Ficha ativa: <b>{activePlan.name}</b></div>
          <div className="flex items-center gap-2"><span>Dia:</span>
            <select className="border border-borderDark bg-black/30 rounded-xl px-3 py-2" value={day} onChange={e=>{setDay(e.target.value);setCursor(0);}}>{DAYS.map(d=><option key={d}>{d}</option>)}</select>
          </div>
          <div className="text-sm text-textSub">Foco no b√°sico. Bora treinar?</div>
          <div className="flex gap-2"><Button variant="accent" onClick={start}>Iniciar treino</Button></div>
        </div>
      </Card>
    );
  }

  if(planItems.length===0) return <Card title="Modo Treino"><div className="text-sm text-textSub">Sem exerc√≠cios para {day}.</div><div className="mt-2"><Button variant="ghost" onClick={back}>Voltar</Button></div></Card>

  const current=planItems[cursor];
  const exMeta = EXS.find(e=> e.id===current?.exId);

  const openPreview=()=>{
    const hasMedia = !!(exMeta && (exMeta.media?.srcMp4 || exMeta.media?.srcWebm));
    setPreviewOpen(true);
  };
  return (
    <Card title="Modo Treino">
      <div className="flex items-center justify-between mb-2">
        <div>
          <div className="text-sm text-textSub">Exerc√≠cio {cursor+1} de {planItems.length}</div>
          <div className="font-semibold text-lg">{current.name}</div>
          {false && <div className="text-xs text-textSub mt-1">√öltima: {lastPerf.sets.map((s,i)=>`S${i+1} ${s.w||"-"}kg√ó${s.r||"-"}${s.rir?` (RIR ${s.rir})`:""}`).join(" | ")}</div>}
        </div>
        <Button variant="ghost" onClick={back}>Voltar p/ iniciar</Button>
      </div>

      {prefs.showTimer && <div className="mb-3"><DarkTimer prefs={prefs}/></div>}
      <div className="grid gap-2">
        {sets.map((s,i)=>(
          <div key={i} className="grid grid-cols-[3rem,1fr,1fr,1fr] items-center gap-2 border border-borderDark rounded-xl p-2">
            <div className="w-12 text-sm text-textSub">S{i+1}</div>
            <input type="number" placeholder={prefs.unit==="kg"?"kg":"lb"} className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full" value={s.w} onChange={e=> setSets(prev=>prev.map((v,ix)=>ix===i?{...v,w:e.target.value}:v))}/>
            <input type="number" placeholder="reps" className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full" value={s.r} onChange={e=> setSets(prev=>prev.map((v,ix)=>ix===i?{...v,r:e.target.value}:v))}/>
            <select className="border border-borderDark bg-black/30 rounded-xl px-2 py-2 text-sm" value={rir[i]} onChange={e=> setRir(prev=>prev.map((v,ix)=>ix===i?e.target.value:v))}>
              <option>--</option><option>Falha</option><option>1</option><option>2</option><option>3</option><option>4</option>
            </select>
          </div>
        ))}
      </div>

      <div className="flex items-center justify-between mt-3">
        <Button variant="ghost" onClick={()=>setCursor(i=>Math.max(0,i-1))} disabled={cursor===0}>Anterior</Button>
        <div className="flex gap-2">
          <Button variant={isDirty? "accent":"success"} onClick={saveCurrent} disabled={!isDirty}>{isDirty? "Salvar":"Salvo ‚úì"}</Button>
          <Button onClick={()=>setCursor(i=>Math.min(planItems.length-1,i+1))} disabled={cursor===planItems.length-1}>Pr√≥ximo</Button>
        </div>
      </div>
    {lastPerf && (
        <div className="mt-3">
          <div className="ds-card rounded-2xl p-3 border border-borderDark">
            <div className="font-medium mb-2">√öltimo Treino</div>
            <div className="space-y-2">
              {lastPerf.sets.map((s,i)=>(
                <div key={i} className="flex items-center justify-between rounded-xl border border-borderDark px-3 py-2">
                  <div className="text-sm text-textSub">S{i+1}</div>
                  <div className="text-base tabular-nums">{(s.w||"-")}{prefs.unit==="kg"?"kg":"lb"} √ó {s.r||"-"}{s.rir?` (RIR ${s.rir})`:""}</div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      
      {/* Preview de execu√ß√£o (inline, GIF-only) */}
      <div className="mt-3">
        <div className="ds-card rounded-2xl p-3 border border-borderDark">
          <div className="font-medium mb-2">Execu√ß√£o do exerc√≠cio</div>
          {(() => {
            const hasGif = !!(exMeta && exMeta.media?.srcGif);
            if (hasGif) {
              return (
                <div className="relative w-full rounded-2xl overflow-hidden border border-borderDark bg-black">
                  <img src={exMeta.media.srcGif} alt={current.name} className="w-full h-auto" />
                </div>
              );
            }
            return (
              <div className="relative w-full rounded-2xl border border-borderDark overflow-hidden">
                <div className="pt-[56.25%] bg-black/30"></div>
                <div className="absolute inset-0 flex items-center justify-center text-textSub text-sm">
                  Pr√©via ainda n√£o dispon√≠vel
                </div>
              </div>
            );
          })()}
        </div>
      </div>
    </Card>
  );
};


// History (cards compact + modal details)
const History=({history, prefs})=>{
  const [weekday,setWeekday]=useState("");
  const [planFilter,setPlanFilter]=useState("");
  const [detail,setDetail]=useState(null); // {date,obj}

  const entries=Object.entries(history).sort((a,b)=>a[0]>b[0]?-1:1);
  const toBR=(iso)=>{const [y,m,d]=iso.split("-");return `${d}/${m}/${y}`;}
  const filtered=entries.filter(([_,o])=>(!weekday||o.day===weekday)&&(!planFilter||o.planName===planFilter));
  const planOptions=[...new Set(entries.map(([,o])=>o.planName).filter(Boolean))];
  const chartsEnabled = !!prefs.chartsPremium;

  const parseNum = (v)=>{ const n = parseFloat(String(v).replace(",", ".")); return isFinite(n)? n : 0; };
  const volSets = (sets)=> sets.reduce((acc,s)=> acc + (parseNum(s.w)*parseNum(s.r)), 0);
  const volSession = (obj)=> (obj.entries||[]).reduce((acc,en)=> acc + volSets(en.sets||[]), 0);

  return (
    <div className="grid gap-4">
      <Card title="Hist√≥rico">
        <div className="flex items-center gap-2 mb-3 flex-wrap">
          <span className="text-sm">Filtrar:</span>
          <select className="border border-borderDark bg-black/30 rounded-xl px-3 py-2" value={weekday} onChange={e=>setWeekday(e.target.value)}>
            <option value="">Dia da semana</option>{DAYS.map(d=><option key={d}>{d}</option>)}
          </select>
          <select className="border border-borderDark bg-black/30 rounded-xl px-3 py-2" value={planFilter} onChange={e=>setPlanFilter(e.target.value)}>
            <option value="">Ficha</option>{planOptions.map(n=><option key={n}>{n}</option>)}
          </select>

          <div className="ml-auto">
            <Button variant="ghost" disabled={!chartsEnabled} onClick={()=> window.openChartsModal && window.openChartsModal()}>
              <span className="inline-flex items-center gap-1">{!chartsEnabled && <LockIcon className="opacity-80"/>} Gr√°ficos</span>
            </Button>
          </div>
        </div>

        {filtered.length===0? <div className="text-sm text-textSub">Sem registros.</div> : (
          <div className="grid gap-3 md:grid-cols-2">
            {filtered.map(([date,obj])=>{
              const vol = Math.round(volSession(obj));
              return (
                <button key={date} onClick={()=>setDetail({date,obj})} className="text-left ds-card rounded-2xl p-3 border border-borderDark hover:bg-white/5 transition">
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="text-sm text-textSub">{obj.day}</div>
                      <div className="font-semibold">{toBR(date)} ‚Äî {obj.planName||"Sem ficha"}</div>
                      <div className="text-xs text-textSub">{obj.entries.length} exerc√≠cio(s)</div>
                    </div>
                    <div className="text-xs text-textSub">Vol: {vol}</div>
                  </div>
                </button>
              );
            })}
          </div>
        )}
      </Card>

      {detail && (
        <Modal onClose={()=>setDetail(null)}>
          <div className="flex items-start justify-between mb-2">
            <div>
              <div className="text-sm text-textSub">{detail.obj.day}</div>
              <div className="font-semibold">{toBR(detail.date)} ‚Äî {detail.obj.planName||"Sem ficha"}</div>
              <div className="text-xs text-textSub">{detail.obj.entries.length} exerc√≠cio(s)</div>
            </div>
            <Button variant="ghost" onClick={()=>setDetail(null)}>Fechar</Button>
          </div>
          <div className="space-y-2 max-h-[60vh] overflow-auto pr-1">
            {detail.obj.entries.map((en,i)=> (
              <div key={i} className="border border-borderDark rounded-xl p-2">
                <div className="flex items-center justify-between">
                  <div className="font-medium">{en.name}</div>
                  <div className="text-xs text-textSub">Vol: {Math.round(volSets(en.sets))}</div>
                </div>
                <div className="flex flex-wrap gap-2 mt-1">
                  {en.sets.map((s,ix)=> (
                    <span key={ix} className="inline-flex items-center rounded-full border border-borderDark px-2 py-0.5 text-xs">
                      S{ix+1}: {s.w||"-"}{(prefs.unit==="kg")?"kg":"lb"} √ó {s.r||"-"}{s.rir?` (RIR ${s.rir})`:""}
                    </span>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </Modal>
      )}
    </div>
  );
};
// Profile (local)


const Profile=({prefs,setPrefs})=>{
  const [name,setName]=useState(prefs.name);
  const [avatar,setAvatar]=useState(prefs.avatar);
  const [unit,setUnit]=useState(prefs.unit);
  const [vibrate,setVibrate]=useState(prefs.vibrate);
  const [goal,setGoal]=useState(prefs.weeklyGoal);
  const [showTimer,setShowTimer]=useState(prefs.showTimer!==false);
  const [timerPreset,setTimerPreset]=useState(Number(prefs.timerPreset||60));
  const [rir,setRir]=useState(typeof prefs.rirDefault==="number"? prefs.rirDefault : 2);
  const [chartsPremium,setChartsPremium]=useState(!!prefs.chartsPremium);
  const dirty = (name!==prefs.name) || (avatar!==prefs.avatar) || (unit!==prefs.unit) || (vibrate!==prefs.vibrate) || (goal!==prefs.weeklyGoal) || ((showTimer)!==(prefs.showTimer!==false)) || ((Number(timerPreset||0))!==(Number(prefs.timerPreset||60))) || ((Number(rir))!==(Number((typeof prefs.rirDefault==="number"? prefs.rirDefault : 2)))) || (chartsPremium!==!!prefs.chartsPremium);

  const [authUser,setAuthUser]=useState(()=>{ try{return JSON.parse(localStorage.getItem('darkset.user'));}catch(_){return null;} });
  useEffect(()=>{
    const id = setInterval(()=>{
      try{ setAuthUser(JSON.parse(localStorage.getItem('darkset.user'))); }catch(_){}
    }, 800);
    return ()=> clearInterval(id);
  },[]);

  // Email auth fields (optional)
  const [em,setEm] = useState("");
  const [pw,setPw] = useState("");
  const [nm,setNm] = useState("");

  return (
    <div className="grid gap-4">
      {authUser && (
<Card title="Perfil">
        <div className="grid gap-3">
          <div className="flex flex-wrap items-center gap-3">
            <div className="text-4xl">{avatar}</div>
            <input className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full sm:w-auto" placeholder="Seu nome" value={name} onChange={e=>setName(e.target.value)}/>
            <input className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full sm:w-24" placeholder="Emoji" value={avatar} onChange={e=>setAvatar(e.target.value)}/>
          </div>
          <div className="flex flex-wrap items-center gap-3">
            <label>Unidade:</label>
            <select className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full sm:w-auto" value={unit} onChange={e=>setUnit(e.target.value)}>
              <option value="kg">kg</option>
              <option value="lb">lb</option>
            </select>
            <label className="ml-4">Vibra√ß√£o:</label>
            <Switch checked={vibrate} onChange={setVibrate}/>
            <label className="ml-4">Meta semanal:</label>
            <input type="number" min="1" max="14" className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full sm:w-20" value={goal} onChange={e=>setGoal(Number(e.target.value)||1)}/>
          </div>
          <div className="flex flex-wrap items-center gap-3">
            <label>DarkTimer</label>
            <Switch checked={showTimer} onChange={setShowTimer}/>
            <label className="ml-4">Tempo padr√£o:</label>
            <select className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full sm:w-auto" value={timerPreset} onChange={e=>setTimerPreset(Number(e.target.value)||60)}>
              <option value="30">30s</option>
              <option value="60">1min</option>
              <option value="90">1min30s</option>
              <option value="120">2min</option>
              <option value="150">2min30s</option>
              <option value="180">3min</option>
            </select>
          </div>
          <div className="flex flex-wrap items-center gap-3">
            <label>RIR padr√£o:</label>
            <select className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full sm:w-auto" value={rir} onChange={e=>setRir(Math.max(0, Math.min(4, Number(e.target.value)||0)))}>
              <option value="0">0 (Falha)</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div className="flex flex-wrap items-center gap-3">
            <label>Gr√°ficos (Premium):</label>
            <Switch checked={chartsPremium} onChange={setChartsPremium}/>
            <span className="text-xs text-textSub">Habilita o bot√£o "Gr√°ficos" no Hist√≥rico.</span>
          </div>
          <div><Button variant="accent" disabled={!dirty} onClick={()=>setPrefs({name,avatar,unit,vibrate,weeklyGoal:goal,showTimer,timerPreset,rirDefault:rir,chartsPremium})}>Salvar perfil</Button></div>
        </div>
      </Card>
)}

      <Card title="Conta">
        {authUser ? (
          <div className="flex flex-wrap items-center justify-between gap-3">
            <div className="text-sm text-textSub">
              Conectado como <b>{authUser.displayName || authUser.email || authUser.uid}</b><br/>
              <span className="opacity-80">uid:</span> <span className="font-mono text-xs">{authUser.uid}</span>
            </div>
            <div className="flex gap-2">
              <Button onClick={()=> window.DSAuth && window.DSAuth.signOut()}>Sair</Button>
            </div>
          </div>) : (
          <div className="grid gap-3">
            <div className="text-sm text-textSub">Entre para salvar seu progresso na nuvem.</div>
            <div className="grid gap-2 sm:grid-cols-2">
              <button className="ds-btn-social" onClick={()=> window.DSAuth && window.DSAuth.signInGoogle()}>
                <span className="ds-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  <path fill="#4285F4" d="M23.5 12.27c0-.84-.07-1.45-.22-2.09H12.22v3.8h6.42c-.13 1.01-.83 2.53-2.39 3.55l-.02.13 3.47 2.69.24.02c2.19-2.02 3.46-4.99 3.46-8.1z"/>
  <path fill="#34A853" d="M12.22 23.5c3.14 0 5.77-1.03 7.69-2.82l-3.66-2.83c-.98.67-2.31 1.14-4.03 1.14-3.08 0-5.68-2.02-6.61-4.82l-.12.01-3.58 2.77-.05.11C2.83 21 7.19 23.5 12.22 23.5z"/>
  <path fill="#FBBC05" d="M5.61 14.17c-.24-.73-.38-1.52-.38-2.35 0-.82.14-1.61.37-2.35l-.01-.16-3.62-2.8-.12.06C.75 8.26.22 10.06.22 11.82c0 1.76.53 3.56 1.63 5.25l3.76-2.9z"/>
  <path fill="#EA4335" d="M12.22 4.64c2.18 0 3.64.94 4.48 1.72l3.26-3.18C17.98 1.2 15.36.14 12.22.14 7.19.14 2.83 2.63.75 6.4l3.84 2.98C5.52 7.58 8.12 4.64 12.22 4.64z"/>
</svg></span>
                <span>Entrar com Google</span>
              </button>
              <button className="ds-btn-social" onClick={()=> alert('Login com Apple em breve')}>
                <span className="ds-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  <path fill="currentColor" d="M16.365 1.43c0 1.14-.46 2.106-1.102 2.82-.705.77-1.866 1.36-2.93 1.29-.133-1.087.54-2.246 1.155-2.922.734-.792 1.976-1.35 2.877-1.49zM20.5 17.02c-.437.982-.64 1.415-1.2 2.286-.78 1.186-1.882 2.667-3.246 2.683-1.216.024-1.532-.796-3.19-.79-1.659.006-2.01.81-3.226.796-1.365-.014-2.41-1.347-3.19-2.532-2.194-3.329-2.428-7.234-1.071-9.3.96-1.478 2.479-2.349 3.917-2.349 1.454 0 2.371.8 3.574.8 1.18 0 1.9-.8 3.575-.8 1.295 0 2.667.705 3.626 1.92-3.19 1.74-2.671 6.283-.469 7.286z"/>
</svg></span>
                <span>Entrar com Apple</span>
              </button>
            </div>
            <div className="border border-borderDark rounded-xl p-3 grid gap-2">
              <div className="text-sm font-medium">Email/telefone + senha</div>
              <input className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full" placeholder="Email ou telefone" value={em} onChange={e=>setEm(e.target.value)}/>
              <input type="password" className="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full" placeholder="Senha" value={pw} onChange={e=>setPw(e.target.value)}/>
              <div className="flex gap-2">
                <Button onClick={()=> window.DSAuth && window.DSAuth.signUpEmail(em, pw, nm)}>Criar conta</Button>
                <Button onClick={()=> window.DSAuth && window.DSAuth.signInEmail(em, pw)}>Entrar</Button>
              </div>
            </div>
          </div>
)}
      </Card>

      <Card>
        <div className="text-sm text-textSub">Fotos da galeria e pack de avatares ficam pro V4 (estrutura j√° preparada).</div>
      </Card>
    </div>
  );
};


function App(){
  const [screen,setScreen]=useState("home");
  const [plans,setPlans]=usePlans();
  const [history,setHistory]=useHistory();
  const [prefs,setPrefs]=usePrefs();
  const [toast,setToast]=useState(null);
  const [builderPlanId,setBuilderPlanId]=useState(null);
  const [viewerPlanId,setViewerPlanId]=useState(null);
  const goto=(s,id=null)=>{ setScreen(s); if(s==='builder' && id) setBuilderPlanId(id); if(s==='viewer' && id) setViewerPlanId(id); };
  useEffect(()=>{ if(toast){ const t=setTimeout(()=>setToast(null),1200); return ()=>clearTimeout(t);} },[toast]);

  // Import via ?import=
  useEffect(()=>{
    const params=new URLSearchParams(location.search);
    const imp=params.get("import");
    if(!imp) return;
    try{
      const txt=decodeURIComponent(imp);
      const json=JSON.parse(decodeURIComponent(escape(atob(txt))));
      // open modal to confirm add
      const days=Object.entries(json.byDay||{}).map(([d,arr])=>`${d}: ${arr.length}`).join(" | ");
      const ok = confirm(`Ficha encontrada: ${json.name}\n${days}\n\nAdicionar ao seu DarkSet?`);
      if(ok){
        const id=Date.now();
        setPlans(p=>({...p,list:[...p.list,{id,name:json.name,byDay:json.byDay||{}}]}));
        setToast("Ficha importada");
        window.history.replaceState({}, "", location.pathname); // clean param
      }
    }catch(e){
      alert("Link de importa√ß√£o inv√°lido.");
    }
  },[]);

  return (
    <div className="max-w-5xl mx-auto p-4 md:p-8 safe-pt safe-pb">
      <header className="ds-hdr">
        <LogoRow/>
        <nav className="ds-nav flex gap-2">
          <button className={"px-4 py-2.5 rounded-xl border border-borderDark "+(screen==="home"?"bg-white/10":"")} onClick={()=>goto("home")}>In√≠cio</button>
          <button className={"px-4 py-2.5 rounded-xl border border-borderDark "+(screen==="plans"?"bg-white/10":"")} onClick={()=>goto("plans")}>Fichas</button>
          <button className={"px-4 py-2.5 rounded-xl border border-borderDark "+(screen==="builder"?"bg-white/10":"")} onClick={()=> goto("builder", plans.activeId || (plans.list[0]?.id ?? null))}>Montar Ficha</button>
          <button className={"px-4 py-2.5 rounded-xl border border-borderDark "+(screen==="session"?"bg-white/10":"")} onClick={()=>goto("session")}>Modo Treino</button>
          <button className={"px-4 py-2.5 rounded-xl border border-borderDark "+(screen==="history"?"bg-white/10":"")} onClick={()=>goto("history")}>Hist√≥rico</button>
          <button className={"px-4 py-2.5 rounded-xl border border-borderDark "+(screen==="profile"?"bg-white/10":"")} onClick={()=>goto("profile")}>Perfil</button>
        </nav>
      </header>

      {screen==="home" && <Home goto={goto} plans={plans} history={history} prefs={prefs}/>}
      {screen==="plans" && <Plans plans={plans} setPlans={setPlans} goto={(s,id)=>goto(s,id)} setToast={setToast}/>}
      {screen==="builder" && <Builder planId={builderPlanId || (plans.activeId || plans.list[0]?.id)} plans={plans} setPlans={setPlans} setToast={setToast}/>}
      {screen==="session" && <Session plans={plans} setHistory={setHistory} history={history} prefs={prefs} goto={goto} setToast={setToast}/>}
      {screen==="history" && <History history={history} prefs={prefs}/>}
      {screen==="viewer" && <Viewer planId={(viewerPlanId || (plans.activeId || plans.list[0]?.id))} plans={plans} goto={goto}/>}
      {screen==="profile" && <Profile prefs={prefs} setPrefs={setPrefs}/>}

      <footer className="mt-8 text-center text-xs text-textSub">¬© <span id="yr"></span> DarkSet ‚Äî V4.7.5</footer>
      {toast && <Toast text={toast}/>}
    </div>
  );
}
const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
(()=>{const y=document.getElementById('yr'); if(y) y.textContent=new Date().getFullYear();})();
</script>

<script>
  // PWA: registra service worker (requer HTTPS ou localhost)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('service-worker.js').catch(function(e){
        console.warn('SW registration failed', e);
      });
    });
  }
</script>

<!-- ===== Modal de Gr√°ficos (IIE) ===== -->
<link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  .charts-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
  .charts-modal{width:min(980px,92vw);max-height:90vh;background:#0b0b0c;color:#eaeaea;border:1px solid #202025;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
  .charts-hd{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid #202025;background:linear-gradient(180deg,#0f0f11 0,#0b0b0c 100%)}
  .charts-hd h3{font-size:16px;font-weight:700;margin:0}
  .charts-help{width:30px;height:30px;border-radius:999px;background:#141418;border:1px solid #2b2b31;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .charts-body{padding:14px 16px;overflow:auto}
  .charts-row{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:700px){.charts-row{grid-template-columns:1fr 1fr}}
  .charts-field{display:flex;flex-direction:column;gap:6px}
  .charts-field label{font-size:12px;opacity:.85}
  .charts-select{background:#111114;color:#eaeaea;border:1px solid #28282c;border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
  .charts-pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .charts-pill{background:#141418;border:1px solid #2b2b31;color:#eaeaea;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
  .charts-pill.active{background:#1f1f25;border-color:#3a3a42}
  .charts-canvas-wrap{margin-top:14px;background:#0e0e12;border:1px solid #1f2024;border-radius:12px;padding:8px}
  .charts-empty{padding:12px;border:1px dashed #2c2c31;border-radius:12px;text-align:center;opacity:.8;display:none}
  .charts-actions{margin-left:auto}
  .charts-btn{background:#1a1a1f;border:1px solid #2c2c31;color:#eaeaea;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
</style>
<div id="chartsModalBackdrop" class="charts-modal-backdrop" aria-hidden="true">
  <div class="charts-modal" role="dialog" aria-modal="true" aria-label="Gr√°ficos de treino">
    <div class="charts-hd">
      <h3>Gr√°ficos de Evolu√ß√£o (IIE)</h3>
      <div class="charts-help" id="chartsHelpBtn">?</div>
      <div class="charts-actions"><button class="charts-btn" id="chartsCloseBtn">Fechar</button></div>
    </div>
    <div class="charts-body">
      <div class="charts-row">
        <div class="charts-field">
          <label for="chartsType">Tipo</label>
          <select id="chartsType" class="charts-select">
            <option value="exercise">Exerc√≠cio</option>
            <option value="muscle">M√∫sculo</option>
            <option value="plan">Ficha</option>
          </select>
        </div>
        <div class="charts-field">
          <label for="chartsSubject">Assunto</label>
          <select id="chartsSubject" class="charts-select"></select>
        </div>
      </div>
      <div class="charts-pills">
        <button class="charts-pill" data-range="7">7d</button>
        <button class="charts-pill" data-range="30">30d</button>
        <button class="charts-pill" data-range="90">90d</button>
        <button class="charts-pill active" data-range="all">Tudo</button>
      </div>
      <div class="charts-canvas-wrap"><canvas id="chartsCanvas" height="260"></canvas></div>
      <div id="chartsEmpty" class="charts-empty">Sem dados para o filtro selecionado.</div>
    </div>
  </div>
</div>
<script>
(function(){
  const LS_HISTORY_KEY = "darkset.v3.history";
  function getHistory(){ try{ return JSON.parse(localStorage.getItem(LS_HISTORY_KEY)) || {}; }catch(e){ return {}; } }
  const toBR = (iso) => { const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; };
  const dayMs = 86400000;

  const RIR_W = { "Falha":1.00, 0:1.00, 1:1.00, 2:0.92, 3:0.84, 4:0.75 };
  const num = (v)=>{ const n=parseFloat(String(v).replace(',', '.')); return isFinite(n)?n:0; };
  const tOf = (iso)=> +new Date(iso+"T00:00:00");

  function primaryOf(name){
    try{
      const meta = (window.EXS||[]).find(e=> e && e.name && e.name.toLowerCase()===String(name).toLowerCase());
      return meta? meta.primary : null;
    }catch(e){ return null; }
  }

  function listSubjects(hist, type){
    const set = new Set();
    for(const [date, obj] of Object.entries(hist)){
      if(!obj || !Array.isArray(obj.entries)) continue;
      if(type==='plan'){ if(obj.planName) set.add(obj.planName); continue; }
      for(const en of obj.entries){
        if(!en || !en.name || !Array.isArray(en.sets)) continue;
        const has = en.sets.some(s=> num(s.r)>0);
        if(!has) continue;
        if(type==='exercise') set.add(en.name);
        if(type==='muscle'){ const p=primaryOf(en.name); if(p) set.add(p); }
      }
    }
    return Array.from(set).sort((a,b)=> a.localeCompare(b));
  }

  function weekStart(d){ // Monday as start
    const dt = new Date(d);
    const day = (dt.getDay()+6)%7; // 0..6 where 0=Mon
    dt.setDate(dt.getDate()-day);
    dt.setHours(0,0,0,0);
    return dt;
  }
  function weekEndFromStart(ws){
    const dt = new Date(+ws + 6*dayMs);
    dt.setHours(0,0,0,0);
    return dt;
  }
  function fmtISO(d){ return d.toISOString().slice(0,10); }

  function buildAgg(hist, type, subject, rangeDays){
    const since = (rangeDays && rangeDays!=='all') ? (Date.now() - Number(rangeDays)*dayMs) : 0;
    const dayMap = new Map(); // iso -> {iie,volume,sets,reps}

    for(const [iso, obj] of Object.entries(hist)){
      const t = tOf(iso); if(since && t < since) continue;
      if(!obj || !Array.isArray(obj.entries)) continue;
      if(type==='plan' && obj.planName !== subject) continue;

      for(const en of obj.entries){
        if(!en || !en.name || !Array.isArray(en.sets)) continue;
        if(type==='exercise' && en.name !== subject) continue;
        if(type==='muscle'){ const p=primaryOf(en.name); if(p!==subject) continue; }

        for(const s of en.sets){
          const r=num(s.r), w=num(s.w);
          if(r<=0) continue;
          const rw = (s.rir in RIR_W) ? RIR_W[s.rir] : (RIR_W[String(s.rir)] ?? 0.90);
          const vol = (w>0 ? w*r : r);
          const iie = vol * rw / 1000.0;

          let acc = dayMap.get(iso);
          if(!acc){ acc={iie:0,volume:0,sets:0,reps:0}; dayMap.set(iso,acc); }
          acc.iie += iie; acc.volume += vol; acc.sets += 1; acc.reps += r;
        }
      }
    }

    // Exerc√≠cio: di√°rio (mantido). M√∫sculo e Ficha: semanal (m√©dia do IIE).
    if(type==='exercise'){
      const labels = Array.from(dayMap.keys()).sort((a,b)=> a.localeCompare(b));
      const series = labels.map(d=> dayMap.get(d));
      const tot = series.reduce((o,s)=>({iie:o.iie+s.iie, vol:o.vol+s.volume, sets:o.sets+s.sets, reps:o.reps+s.reps}), {iie:0,vol:0,sets:0,reps:0});
      const delta = (series.length>1)? Math.round(((series.at(-1).iie - series[0].iie)/Math.max(1e-6, series[0].iie))*100) : 0;
      window.__chartsWeekTitles = null; // reset
      return { labels: labels.map(toBR), series, tot, delta };
    }

    // Agrupamento semanal para muscle/plan
    const wkMap = new Map(); // wsISO -> {sumIie, days, volume, sets, reps, ws, we}
    for(const [iso, vals] of Array.from(dayMap.entries())){
      const ws = weekStart(new Date(iso+"T00:00:00"));
      const we = weekEndFromStart(ws);
      const key = fmtISO(ws);
      let acc = wkMap.get(key);
      if(!acc){ acc={sumIie:0, days:0, volume:0, sets:0, reps:0, ws:ws, we:we}; wkMap.set(key, acc); }
      acc.sumIie += vals.iie; acc.days += 1;
      acc.volume += vals.volume; acc.sets += vals.sets; acc.reps += vals.reps;
    }
    const weeks = Array.from(wkMap.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
    const labels = [];
    const series = [];
    const titles = [];
    let idx = 1;
    for(const [key, v] of weeks){
      labels.push("Sem " + (idx++));
      series.push({ iie: v.days? v.sumIie / v.days : 0, volume: v.volume, sets: v.sets, reps: v.reps });
      titles.push(`${toBR(fmtISO(v.ws))} ‚Äî ${toBR(fmtISO(v.we))}`);
    }
    const tot = series.reduce((o,s)=>({iie:o.iie+s.iie, vol:o.vol+s.volume, sets:o.sets+s.sets, reps:o.reps+s.reps}), {iie:0,vol:0,sets:0,reps:0});
    const delta = (series.length>1)? Math.round(((series.at(-1).iie - series[0].iie)/Math.max(1e-6, series[0].iie))*100) : 0;
    window.__chartsWeekTitles = titles;
    return { labels, series, tot, delta };
}

  let chart;
  function renderChart(labels, series){
    const elEmpty = document.getElementById('chartsEmpty');
    const ctx = document.getElementById('chartsCanvas');
    if(chart){ chart.destroy(); chart=null; }
    if(!labels.length){ elEmpty.style.display=''; return; } else { elEmpty.style.display='none'; }
    const data = series.map(s=> s.iie);
    const titles = window.__chartsWeekTitles;

    chart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{label:'IIE', data, borderWidth:2, tension:.25, pointRadius:4, pointHoverRadius:5, borderColor:'#ff3b30', backgroundColor:'rgba(255,59,48,.2)'}]},
      options:{
        responsive:true, maintainAspectRatio:false, interaction:{mode:'index', intersect:false},
        plugins:{
          legend:{display:false},
          tooltip:{
            enabled:true,
            callbacks:{
              title:(items)=>{
                const i = items && items.length? items[0].dataIndex : 0;
                return titles && titles[i] ? titles[i] : items[0].label;
              },
              label:(item)=> `IIE: ${Number(item.raw).toFixed(3)}`
            }
          }
        },
        scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true } }, y:{ beginAtZero:true } }
      }
    });
  }

  function refillAndPlot(defaults){
    const hist = getHistory();
    const typeSel = document.getElementById('chartsType');
    const subjSel = document.getElementById('chartsSubject');
    const pills = Array.from(document.querySelectorAll('.charts-pill'));
    if(defaults && defaults.type) typeSel.value = defaults.type;

    function fillSubj(){
      const list = listSubjects(hist, typeSel.value);
      subjSel.innerHTML = '';
      if(!list.length){ subjSel.innerHTML = '<option>Sem dados</option>'; renderChart([],[]); return; }
      for(const name of list){ const o=document.createElement('option'); o.value=name; o.textContent=name; subjSel.appendChild(o); }
      if(defaults && defaults.subject && list.includes(defaults.subject)) subjSel.value = defaults.subject;
    }
    fillSubj();

    let range = 'all';
    function plot(){
      const {labels, series} = buildAgg(hist, typeSel.value, subjSel.value, range);
      renderChart(labels, series);
    }
    plot();

    typeSel.onchange = ()=>{ fillSubj(); plot(); };
    subjSel.onchange = ()=> plot();
    pills.forEach(p=> p.onclick = ()=>{ pills.forEach(x=>x.classList.remove('active')); p.classList.add('active'); range=p.dataset.range; plot(); });
  }

  // expose
  window.openChartsModal = function(defaultExerciseName){
    const el = document.getElementById('chartsModalBackdrop'); if(!el) return;
    el.style.display='flex';
    const defaults = defaultExerciseName? {type:'exercise', subject: defaultExerciseName} : null;
    setTimeout(()=> refillAndPlot(defaults), 0);
  };
  window.closeChartsModal = function(){ const el = document.getElementById('chartsModalBackdrop'); if(el) el.style.display='none'; };

  // bind header buttons
  document.getElementById('chartsCloseBtn')?.addEventListener('click', ()=> window.closeChartsModal());
  document.getElementById('chartsHelpBtn')?.addEventListener('click', ()=>{
    const msg = 'IIE (√çndice de Intensidade Efetiva) resume progresso levando em conta carga x repeti√ß√µes x s√©ries ajustadas pelo RIR. '      +'No filtro "M√∫sculo", os pontos representam a M√âDIA do IIE da semana. Use 7d/30d/90d/Tudo para mudar o intervalo.';
    alert(msg);
  });

  // Auto-bind on any button/anchor with text "Gr√°fico"
  document.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button, a'); if(!btn) return;
    const t = (btn.innerText || btn.textContent || '').toLowerCase();
    if(t.includes('gr√°fico')){ ev.preventDefault(); window.openChartsModal(); }
  });
})();
</script>
<!-- ===== /Modal de Gr√°ficos ===== -->


<!-- Firebase compat SDKs para encurtar link no Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
(function(){
  try{
    var firebaseConfig = {
      apiKey: "AIzaSyB3bu3XercwmnlV0jdaldoXvd5gnHfj0GU",
      authDomain: "darkset-538d1.firebaseapp.com",
      projectId: "darkset-538d1",
      storageBucket: "darkset-538d1.firebasestorage.app",
      messagingSenderId: "354165019689",
      appId: "1:354165019689:web:dc458f0a61e26e6289f838",
      measurementId: "G-PVJ7QJ0T7F"
    };
    if (window.firebase) {
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      window._db = firebase.firestore();
    }
  }catch(e){ console.warn('Firebase init falhou', e); }

  function b64ToJson(b64){
    try { return JSON.parse(decodeURIComponent(escape(atob(b64)))); } catch(e){ return null; }
  }
  function jsonToB64(obj){
    try { return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); } catch(e){ return ''; }
  }

  async function handleIdParam(){
    try{
      var url = new URL(location.href);
      var id = url.searchParams.get('id');
      if(!id) return;
      if(!window._db){ console.warn('Firestore n√£o pronto'); return; }
      var snap = await window._db.collection('fichas').doc(id).get();
      if(!snap.exists){ console.warn('share id n√£o encontrado'); return; }
      var data = snap.data() || {};
      var payload = { 
        name: data.name || data.title || "Importada", 
        byDay: data.byDay || data.Semana || data.semana || {} 
      };
      url.searchParams.delete('id');
      url.searchParams.set('import', jsonToB64(payload));
      location.replace(url.toString());
    }catch(e){ console.warn('handleIdParam erro', e); }
  }

  var shortenedOnce = false;
  async function tryShortenCurrent(){
    try{
      if(shortenedOnce) return;
      var inp = document.getElementById('share-link');
      if(!inp) return;
      var val = inp.value || '';
      if(!val.includes('?import=')) return;
      if(!window._db) return;
      var b64 = (new URL(val, location.href)).searchParams.get('import');
      var obj = b64ToJson(b64); if(!obj) return;
      var addRes = await window._db.collection('fichas').add(Object.assign({}, obj, { ts: Date.now() }));
      var shortUrl = location.origin + '/?id=' + addRes.id;
      inp.value = shortUrl;
      var qb = document.getElementById('qr-box');
      if(qb && window.QRCode){ qb.innerHTML=''; new QRCode(qb, { text: shortUrl, width: 196, height: 196 }); }
      shortenedOnce = true;
    }catch(e){ console.warn('shortenCurrent erro', e); }
  }

  var obs = new MutationObserver(()=>{ tryShortenCurrent(); });
  obs.observe(document.documentElement || document.body, { childList:true, subtree:true });

  document.addEventListener('DOMContentLoaded', ()=>{ tryShortenCurrent(); handleIdParam(); });
})();
</script>


<!-- DS_PATCH_FIRESTORE_ONLY -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
(function(){ 
  // ---- Init Firebase (compat) ----
  try{ 
    var firebaseConfig = { 
      apiKey: "AIzaSyB3bu3XercwmnlV0jdaldoXvd5gnHfj0GU",
      authDomain: "darkset-538d1.firebaseapp.com",
      projectId: "darkset-538d1",
      storageBucket: "darkset-538d1.firebasestorage.app",
      messagingSenderId: "354165019689",
      appId: "1:354165019689:web:dc458f0a61e26e6289f838",
      measurementId: "G-PVJ7QJ0T7F"
    };
    if (window.firebase) { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); window._db = firebase.firestore(); }
  }catch(e){ console.warn('Firebase init failed', e); }

  // ---- Helpers ----
  function b64ToJson(b64){ try { return JSON.parse(decodeURIComponent(escape(atob(b64)))); } catch(e){ return null; } }
  function jsonToB64(obj){ try { return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); } catch(e){ return ''; } }

  // ---- Handle open with ?id=... ----
  async function handleIdParam(){ 
    try{ 
      var url = new URL(location.href);
      var id = url.searchParams.get('id');
      if(!id) return;
      if(!window._db) return console.warn('Firestore not ready');
      var snap = await window._db.collection('fichas').doc(id).get();
      if(!snap.exists) return console.warn('share id not found');
      var data = snap.data() || {};
      var payload = { name: data.name || data.title || "Importada", byDay: data.byDay || data.Semana || data.semana || {} };
      url.searchParams.delete('id');
      url.searchParams.set('import', jsonToB64(payload));
      location.replace(url.toString());
    }catch(e){ console.warn('handleIdParam error', e); }
  }

  // ---- Observe Share modal and replace long link with short Firestore link ----
  var replacedOnce = false;
  async function fireStoreShorten(){ 
    try{ 
      if(replacedOnce) return;
      var inp = document.getElementById('share-link');
      if(!inp) return;
      var qb  = document.getElementById('qr-box');
      var val = inp.value || '';

      // If the app still wrote a long ?import=..., we convert it transparently
      var imp = null;
      if(val.includes('?import=')){ 
        imp = (new URL(val, location.href)).searchParams.get('import');
      }
      // If nothing to shorten yet, bail
      if(!imp) return;

      if(qb) qb.innerHTML = '<div style="padding:6px;font-size:12px;opacity:.8">Gerando link curto‚Ä¶</div>';
      inp.value = 'gerando‚Ä¶';

      if(!window._db) return; // keep fallback visual

      var obj = b64ToJson(imp);
      if(!obj || !obj.byDay) return;

      var docRef = await window._db.collection('fichas').add(Object.assign({}, obj, { ts: Date.now() }));
      var shortUrl = location.origin + '/?id=' + docRef.id;

      inp.value = shortUrl;
      if(qb && window.QRCode){ qb.innerHTML=''; new QRCode(qb, { text: shortUrl, width: 196, height: 196 }); }
      replacedOnce = true;
    }catch(e){ console.warn('fireStoreShorten error', e); }
  }

  // Observe DOM mutations to catch when the share modal is inserted/updated
  var mo = new MutationObserver(function(){ fireStoreShorten(); });
  mo.observe(document.documentElement || document.body, { subtree: true, childList: true });

  document.addEventListener('DOMContentLoaded', function(){ handleIdParam(); fireStoreShorten(); });
})();
</script>


<script>
/* DS_AUTH_START */
(function(){
  try{
    if(!window.firebase) return;
    if(!firebase.apps || !firebase.apps.length){
      var firebaseConfig = {
        apiKey: "AIzaSyB3bu3XercwmnlV0jdaldoXvd5gnHfj0GU",
        authDomain: "darkset-538d1.firebaseapp.com",
        projectId: "darkset-538d1",
        storageBucket: "darkset-538d1.firebasestorage.app",
        messagingSenderId: "354165019689",
        appId: "1:354165019689:web:dc458f0a61e26e6289f838",
        measurementId: "G-PVJ7QJ0T7F"
      };
      firebase.initializeApp(firebaseConfig);
    }
    var auth = firebase.auth();
    var db   = window._db || (firebase.firestore && firebase.firestore());

    // Expose helper API
    window.DSAuth = {
      signInGoogle: async function(){
        try {
          var provider = new firebase.auth.GoogleAuthProvider();
          if (window.innerWidth > 640) {
            await auth.signInWithPopup(provider);
          } else {
            await auth.signInWithRedirect(provider);
          }
        } catch(e) {
          try {
            await auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());
          } catch(err) {
            alert('Falha ao entrar com Google: ' + (e && e.message ? e.message : ''));
          }
        }
      },
      signOut: function(){ return auth.signOut(); },
      signUpEmail: function(email, pass, name){
        return auth.createUserWithEmailAndPassword(email, pass).then(function(cred){
          if(name) return cred.user.updateProfile({ displayName: name });
        });
      },
      signInEmail: function(email, pass){
        return auth.signInWithEmailAndPassword(email, pass);
      }
    };

    auth.onAuthStateChanged(async function(user){
      try{
        if(user){
          var info = {
            uid: user.uid,
            email: user.email || null,
            displayName: user.displayName || null,
            photoURL: user.photoURL || null,
            lastLogin: Date.now()
          };
          localStorage.setItem('darkset.user', JSON.stringify(info));
          try{
            if(db){
              await db.collection('users').doc(user.uid).set({
                email: info.email,
                name: info.displayName,
                photoURL: info.photoURL,
                updatedAt: Date.now()
              }, { merge: true });
            }
          }catch(_){}
          try {
            var prefs = JSON.parse(localStorage.getItem('darkset.v3.prefs')||'{}');
            if(info.displayName && !prefs.name){
              prefs.name = info.displayName;
              localStorage.setItem('darkset.v3.prefs', JSON.stringify(prefs));
            }
          }catch(_){}
        } else {
          localStorage.removeItem('darkset.user');
        }
      }catch(_){}
    });
  }catch(e){ console.warn('DSAuth init error', e); }
})();
/* DS_AUTH_END */
</script>


<!-- === Auth Popup === -->
<style>
  .auth-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99999}
  .auth-card{width:min(520px,92vw);background:#0b0b0c;border:1px solid #1f2024;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5);color:#eaeaea;overflow:hidden}
  .auth-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2024;background:linear-gradient(180deg,#0f0f11,#0b0b0c)}
  .auth-title{font-weight:700;font-size:16px}
  .auth-x{appearance:none;background:transparent;border:0;color:#a9a9b0;font-size:18px;cursor:pointer;line-height:1}
  .auth-body{padding:14px 16px;display:grid;gap:10px}
  .auth-social{display:flex;flex-direction:column;gap:8px}
  .btn-social{display:flex;align-items:center;gap:10px;justify-content:center;background:#fff;color:#111;border:1px solid #e5e5e5;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
  .btn-social .ico{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center}
  .btn-social .ico.g{background: none}
  .btn-social .ico.a{background: none}
  .auth-sep{height:1px;background:#1f2024;margin:2px 0}
  .auth-field{display:flex;flex-direction:column;gap:6px}
  .auth-input{background:#111114;border:1px solid #28282c;border-radius:10px;color:#eaeaea;padding:10px 12px;font-size:14px;outline:none}
  .auth-primary{display:flex;gap:8px;justify-content:flex-end}
  .auth-btn{background:#6e5bff;border:1px solid #7b6cff;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:700}
  .auth-muted{font-size:12px;color:#a9a9b0;text-align:center}
  .auth-muted button{background:none;border:0;color:#c7c7ff;text-decoration:underline;cursor:pointer}
</style>


<div id="authModalBackdrop" class="auth-backdrop" aria-hidden="true">
  <div class="auth-card" role="dialog" aria-modal="true" aria-label="Autentica√ß√£o">
    <div class="auth-hd">
      <div class="auth-title">Entrar</div>
      <button class="auth-x" data-auth-close aria-label="Fechar">‚úï</button>
    </div>
    <div class="auth-body">
      <div class="auth-social">
        <button class="btn-social" data-auth-google>
          <span class="ico g" aria-hidden="true"><svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg">
  <path fill="#4285F4" d="M23.5 12.27c0-.84-.07-1.45-.22-2.09H12.22v3.8h6.42c-.13 1.01-.83 2.53-2.39 3.55l-.02.13 3.47 2.69.24.02c2.19-2.02 3.46-4.99 3.46-8.1z"/>
  <path fill="#34A853" d="M12.22 23.5c3.14 0 5.77-1.03 7.69-2.82l-3.66-2.83c-.98.67-2.31 1.14-4.03 1.14-3.08 0-5.68-2.02-6.61-4.82l-.12.01-3.58 2.77-.05.11C2.83 21 7.19 23.5 12.22 23.5z"/>
  <path fill="#FBBC05" d="M5.61 14.17c-.24-.73-.38-1.52-.38-2.35 0-.82.14-1.61.37-2.35l-.01-.16-3.62-2.8-.12.06C.75 8.26.22 10.06.22 11.82c0 1.76.53 3.56 1.63 5.25l3.76-2.9z"/>
  <path fill="#EA4335" d="M12.22 4.64c2.18 0 3.64.94 4.48 1.72l3.26-3.18C17.98 1.2 15.36.14 12.22.14 7.19.14 2.83 2.63.75 6.4l3.84 2.98C5.52 7.58 8.12 4.64 12.22 4.64z"/>
</svg></span><span>Entrar com Google</span>
        </button>
        <button class="btn-social" data-auth-apple>
          <span class="ico a" aria-hidden="true"><svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg">
  <path fill="black" d="M16.36 1.43c0 1.14-.46 2.1-1.1 2.82-.7.77-1.86 1.36-2.93 1.29-.13-1.09.54-2.25 1.15-2.92.73-.79 1.98-1.35 2.88-1.19zM20.5 17.02c-.44.98-.64 1.41-1.2 2.29-.78 1.19-1.88 2.67-3.25 2.69-1.22.02-1.53-.8-3.19-.79-1.66.01-2.01.81-3.23.79-1.37-.02-2.41-1.35-3.19-2.54-2.2-3.33-2.43-7.23-1.07-9.29.96-1.48 2.48-2.35 3.92-2.35 1.45 0 2.36.8 3.57.8 1.18 0 1.89-.8 3.57-.8 1.29 0 2.67.7 3.63 1.92-3.19 1.7-2.67 6.25-.46 7.26z"/>
</svg></span><span>Entrar com Apple</span>
        </button>
      </div>
      <div class="auth-sep"></div>
      <div class="auth-field">
        <label style="font-size:12px;opacity:.85">Email ou telefone</label>
        <input class="auth-input" id="authEmailPhone" placeholder="email@exemplo.com ou (11) 99999‚Äë9999" autocomplete="username" />
      </div>
      <div class="auth-field">
        <label style="font-size:12px;opacity:.85">Senha</label>
        <input class="auth-input" id="authPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>
      <div class="auth-primary">
        <button class="auth-btn" data-auth-primary>Entrar</button>
      </div>
      <div class="auth-muted">
        Ainda n√£o tem uma conta?
        <button type="button" data-auth-toggle>Criar conta</button>
      </div>
    </div>
  </div>
</div>


<script>
(function(){
  let mode = 'signIn';
  const backdrop = document.getElementById('authModalBackdrop');
  if(!backdrop) return;
  const btnClose = backdrop.querySelector('[data-auth-close]');
  const btnGoogle = backdrop.querySelector('[data-auth-google]');
  const btnApple  = backdrop.querySelector('[data-auth-apple]');
  const btnPrimary= backdrop.querySelector('[data-auth-primary]');
  const btnToggle = backdrop.querySelector('[data-auth-toggle]');
  const inputEmail= backdrop.querySelector('#authEmailPhone');
  const inputPass = backdrop.querySelector('#authPassword');

  function setMode(m){
    mode = m;
    const title = backdrop.querySelector('.auth-title');
    const primary = backdrop.querySelector('[data-auth-primary]');
    const muted = backdrop.querySelector('.auth-muted');
    if(title) title.textContent = (mode==='signUp')? 'Criar conta' : 'Entrar';
    if(primary) primary.textContent = (mode==='signUp')? 'Criar conta' : 'Entrar';
    if(muted){
      muted.innerHTML = (mode==='signUp')
        ? 'J√° tem uma conta? <button type="button" data-auth-toggle>Entrar</button>'
        : 'Ainda n√£o tem uma conta? <button type="button" data-auth-toggle>Criar conta</button>';
      muted.querySelector('[data-auth-toggle]').addEventListener('click', ()=> setMode(mode==='signUp'?'signIn':'signUp'), {once:true});
    }
  }

  function openAuthModal(m){ setMode(m||'signIn'); backdrop.style.display='flex'; }
  function closeAuthModal(){ backdrop.style.display='none'; }
  window.openAuthModal = openAuthModal;

  btnClose && btnClose.addEventListener('click', closeAuthModal);
  btnGoogle && btnGoogle.addEventListener('click', async ()=>{
    try{ if(window.DSAuth && DSAuth.signInGoogle){ await DSAuth.signInGoogle(); closeAuthModal(); } }
    catch(e){ alert(e && e.message ? e.message : String(e)); }
  });
  btnApple && btnApple.addEventListener('click', async ()=>{
    try{
      if(window.DSAuth && DSAuth.signInApple){ await DSAuth.signInApple(); closeAuthModal(); }
      else { alert('Login com Apple indispon√≠vel neste dispositivo/navegador.'); }
    }catch(e){ alert(e && e.message ? e.message : String(e)); }
  });
  btnPrimary && btnPrimary.addEventListener('click', async ()=>{
    try{
      const email = (inputEmail && inputEmail.value || '').trim();
      const pass = (inputPass && inputPass.value || '').trim();
      if(!email || !pass){ alert('Preencha email/telefone e senha.'); return; }
      if(window.DSAuth){
        if(mode==='signUp' && DSAuth.signUpEmail){ await DSAuth.signUpEmail(email, pass); }
        else if(DSAuth.signInEmail){ await DSAuth.signInEmail(email, pass); }
        closeAuthModal();
      }
    }catch(e){ alert(e && e.message ? e.message : String(e)); }
  });
  btnToggle && btnToggle.addEventListener('click', ()=> setMode(mode==='signUp'?'signIn':'signUp'));

  // Auto-open once for first-time visitors without user
  try{
    const hasUser = !!JSON.parse(localStorage.getItem('darkset.user')||'null');
    if(!hasUser){ setTimeout(()=> openAuthModal('signIn'), 400); }
  }catch(_){}

  // Turn the "Acesso" card buttons into popup triggers and hide big "Criar conta"
  const obs = new MutationObserver(()=>{
    document.querySelectorAll('.ds-card').forEach(card=>{
      const title = card.querySelector('.font-semibold.text-lg');
      if(!title) return;
      if((title.textContent||'').trim() !== 'Acesso') return;
      const btns = card.querySelectorAll('button');
      btns.forEach(btn=>{
      const label = (btn.textContent||'').trim().toLowerCase();
      if(label === 'entrar'){
        btn.onclick = ()=> openAuthModal('signIn');
        // Make it look like the popup primary
        btn.className = 'ds-enter';
      }
      if(label === 'criar conta'){
          btn.style.display='none';
          if(!card.querySelector('[data-inline-create]')){
            const div = document.createElement('div');
            div.setAttribute('data-inline-create','1');
            div.className = 'w-full text-right text-xs';
            div.style.opacity = '.8';
            div.style.marginTop = '4px';
            div.innerHTML = 'Ainda n√£o tem uma conta? <a href="#" style="text-decoration:underline;color:#c7c7ff;cursor:pointer">Criar conta</a>';
            div.querySelector('a').onclick = (ev)=>{ ev.preventDefault(); openAuthModal('signUp'); };
            card.appendChild(div);
          }
        }
      });
    });
  });
  obs.observe(document.body, {subtree:true, childList:true});
})();
</script>


<script>
// Optional Apple provider (only works if Apple foi habilitado no Firebase)
(function(){
  if(!window.firebase || !firebase.auth) return;
  if(!window.DSAuth) window.DSAuth = {};
  if(!DSAuth.signInApple){
    DSAuth.signInApple = async function(){
      try{
        const provider = new firebase.auth.OAuthProvider('apple.com');
        provider.addScope('email'); provider.addScope('name');
        try{ await firebase.auth().signInWithPopup(provider); }
        catch(err){
          if(err && err.code === 'auth/operation-not-supported-in-this-environment'){
            await firebase.auth().signInWithRedirect(provider);
          }else{ throw err; }
        }
      }catch(e){ alert(e && e.message ? e.message : String(e)); }
    };
  }
})();
</script>

<!-- === /Auth Popup === -->

<style>
  /* fix: alinhamento do √≠cone do Google no popup */
  .btn-social .ico svg { width:18px; height:18px; display:block; }
</style>
<script>
(function(){
  function openAuth(){ if(window.openAuthModal) openAuthModal('signIn'); }

  function injectCreateLink(container){
    if(!container || container.querySelector('[data-inline-create]')) return;
    const div = document.createElement('div');
    div.setAttribute('data-inline-create','1');
    div.className = 'w-full text-right text-xs';
    div.style.opacity = '.8';
    div.style.marginTop = '4px';
    div.innerHTML = 'Ainda n√£o tem uma conta? <a href="#" style="text-decoration:underline;color:#c7c7ff;cursor:pointer">Criar conta</a>';
    div.querySelector('a').onclick = function(ev){ ev.preventDefault(); ev.stopImmediatePropagation(); ev.stopPropagation(); if(window.openAuthModal) openAuthModal('signUp'); };
    container.appendChild(div);
  }

  function styleEnter(btn){
    if(!btn) return;
    btn.className = 'ds-enter';
  }

  function wireEnter(btn){
    if(!btn) return;
    btn.addEventListener('click', function(ev){
      ev.preventDefault();
      ev.stopImmediatePropagation(); ev.stopPropagation();
      ev.stopImmediatePropagation();
      openAuth();
    }, true);
    btn.onclick = function(ev){ ev.preventDefault(); openAuth(); };
  }

  function tweak(){
    document.querySelectorAll('.ds-card').forEach(function(card){
      const titleEl = card.querySelector('.font-semibold.text-lg');
      if(!titleEl) return;
      const ttl = (titleEl.textContent||'').trim();

      if(ttl === 'Acesso'){
        const btns = card.querySelectorAll('button');
        btns.forEach(function(b){
          const label = (b.textContent||'').trim().toLowerCase();
          if(label === 'entrar'){
            styleEnter(b);
            wireEnter(b);
          }
          if(label === 'criar conta'){
            b.style.display = 'none';
            injectCreateLink(card);
          }
        });
      }

      if(ttl === 'Conta'){
        const formBox = card.querySelector('.border.border-borderDark.rounded-xl.p-3');
        if(formBox){
          const row = formBox.querySelector('.flex.gap-2');
          if(row){
            row.querySelectorAll('button').forEach(function(b){
              const label = (b.textContent||'').trim().toLowerCase();
              if(label === 'criar conta'){ b.style.display = 'none'; }
              if(label === 'entrar'){ styleEnter(b); }
            });
          }
          injectCreateLink(formBox);
        }
      }
    });
  }

  const mo = new MutationObserver(function(){ tweak(); });
  mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', tweak); } else { tweak(); }
})();
</script>

<style>
/* fix-google-icon: stronger alignment */
.btn-social .ico{ line-height:0 !important; display:inline-flex !important; align-items:center !important; justify-content:center !important; }
.btn-social .ico svg{ width:18px !important; height:18px !important; display:block !important; }
</style>


<!-- DarkSet Auto-Inject: Profile Inline Auth + SMS in Popup -->
<script>
(function(){
  // Utility: wait for element
  function waitFor(fn, timeout=8000, step=100){
    return new Promise((resolve, reject)=>{
      const t0 = Date.now();
      (function loop(){
        try{
          const el = fn();
          if (el) return resolve(el);
          if (Date.now()-t0 > timeout) return reject(new Error('waitFor timeout'));
        }catch(_){}
        setTimeout(loop, step);
      })();
    });
  }
  function isNode(el){ return el && el.nodeType === 1; }

  // ===== Inline Auth on Profile ("Conta") - no popup =====
  function mountProfileInlineAuth(){
    try{
      // Find the Profile "Conta" card by title text
      const cards = document.querySelectorAll('.ds-card');
      let contaCard = null, titleEl = null;
      cards.forEach(c=>{
        const t = c.querySelector('.font-semibold, .text-lg, h3, .ds-card-title');
        if(!t) return;
        const txt = (t.textContent||'').trim().toLowerCase();
        if (txt === 'conta') { contaCard = c; titleEl = t; }
      });
      if(!contaCard) return; // nothing to do

      // If already logged in, don't replace UI
      let user = null;
      try { user = JSON.parse(localStorage.getItem('darkset.user')||'null'); } catch(_){}
      if (user && user.uid) return;

      // If we've already mounted once, skip
      if (contaCard.querySelector('[data-inline-auth-root]')) return;

      // Clear existing content inside the card body (but keep the title/header if present)
      const body = contaCard.querySelector('.ds-card-body') || contaCard;
      const root = document.createElement('div');
      root.setAttribute('data-inline-auth-root','1');
      root.className = 'grid gap-3';

      root.innerHTML = `
        <div class="text-sm text-textSub">Entre para salvar seu progresso na nuvem.</div>

        <div class="grid gap-2 sm:grid-cols-2">
          <button class="ds-btn-social" data-inline-google>
            <span class="ds-icon">
              <svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                <path fill="#4285F4" d="M23.5 12.27c0-.84-.07-1.45-.22-2.09H12.22v3.8h6.42c-.13 1.01-.83 2.53-2.39 3.55l-.02.13 3.47 2.69.24.02c2.19-2.02 3.46-4.99 3.46-8.1z"/>
                <path fill="#34A853" d="M12.22 23.5c3.14 0 5.77-1.03 7.69-2.82l-3.66-2.83c-.98.67-2.31 1.14-4.03 1.14-3.08 0-5.68-2.02-6.61-4.82l-.12.01-3.58 2.77-.05.11C2.83 21 7.19 23.5 12.22 23.5z"/>
                <path fill="#FBBC05" d="M5.61 14.17c-.24-.73-.38-1.52-.38-2.35 0-.82.14-1.61.37-2.35l-.01-.16-3.62-2.8-.12.06C.75 8.26.22 10.06.22 11.82c0 1.76.53 3.56 1.63 5.25l3.76-2.9z"/>
                <path fill="#EA4335" d="M12.22 4.64c2.18 0 3.64.94 4.48 1.72l3.26-3.18C17.98 1.2 15.36.14 12.22.14 7.19.14 2.83 2.63.75 6.4l3.84 2.98C5.52 7.58 8.12 4.64 12.22 4.64z"/>
              </svg>
            </span>
            <span>Entrar com Google</span>
          </button>
          <button class="ds-btn-social" data-inline-apple>
            <span class="ds-icon">
              <svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                <path fill="currentColor" d="M16.365 1.43c0 1.14-.46 2.106-1.102 2.82-.705.77-1.866 1.36-2.93 1.29-.133-1.087.54-2.246 1.155-2.922.734-.792 1.976-1.35 2.877-1.49zM20.5 17.02c-.437.982-.64 1.415-1.2 2.286-.78 1.186-1.882 2.667-3.246 2.683-1.216.024-1.532-.796-3.19-.79-1.659.006-2.01.81-3.226.796-1.365-.014-2.41-1.347-3.19-2.532-2.194-3.329-2.428-7.234-1.071-9.3.96-1.478 2.479-2.349 3.917-2.349 1.454 0 2.371.8 3.574.8 1.18 0 1.9-.8 3.575-.8 1.295 0 2.667.705 3.626 1.92-3.19 1.74-2.671 6.283-.469 7.286z"/>
              </svg>
            </span>
            <span>Entrar com Apple</span>
          </button>
        </div>

        <div class="border border-borderDark rounded-xl p-3 grid gap-2">
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium" data-inline-title>Entrar com email</div>
            <button class="text-xs underline text-textSub" data-inline-toggle>Criar conta</button>
          </div>
          <div class="grid gap-2" data-inline-email-wrap>
            <input class="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full" placeholder="Email" data-inline-email />
            <input type="password" class="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full" placeholder="Senha" data-inline-pass />
          </div>
          <div class="grid gap-2" data-inline-signup-extra style="display:none">
            <input class="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full" placeholder="Seu nome (opcional)" data-inline-name />
            <input type="password" class="border border-borderDark bg-black/30 rounded-xl px-3 py-2 w-full" placeholder="Confirmar senha" data-inline-pass2 />
          </div>
          <div class="flex gap-2 justify-end">
            <button class="ds-btn" data-inline-primary>Entrar</button>
          </div>
          <div class="text-xs text-textSub">Para login por <b>telefone (SMS)</b>, use o bot√£o <i>Entrar</i> da tela inicial para abrir o popup.</div>
        </div>
      `;

      // Replace body content (keep title if present)
      const container = body;
      Array.from(container.children).forEach(ch => {
        if (titleEl && ch === titleEl.parentElement) return; // keep header if structured like that
      });
      container.appendChild(root);

      // Wire handlers
      const $ = sel => root.querySelector(sel);
      const btnGoogle = $('[data-inline-google]');
      const btnApple  = $('[data-inline-apple]');
      const btnToggle = $('[data-inline-toggle]');
      const btnPrim   = $('[data-inline-primary]');
      const title     = $('[data-inline-title]');
      const wrapExtra = $('[data-inline-signup-extra]');
      const inpEmail  = $('[data-inline-email]');
      const inpPass   = $('[data-inline-pass]');
      const inpPass2  = $('[data-inline-pass2]');
      const inpName   = $('[data-inline-name]');
      let mode = 'signIn';

      function setMode(m){
        mode = m;
        if (title) title.textContent = (mode==='signUp') ? 'Criar conta com email' : 'Entrar com email';
        if (btnToggle) btnToggle.textContent = (mode==='signUp') ? 'J√° tem uma conta? Entrar' : 'Criar conta';
        if (wrapExtra) wrapExtra.style.display = (mode==='signUp') ? 'grid' : 'none';
        if (btnPrim) btnPrim.textContent = (mode==='signUp') ? 'Criar conta' : 'Entrar';
      }

      btnToggle && btnToggle.addEventListener('click', ()=> setMode(mode==='signUp'?'signIn':'signUp'));
      btnGoogle && btnGoogle.addEventListener('click', async ()=>{
        try{ if(window.DSAuth && DSAuth.signInGoogle){ await DSAuth.signInGoogle(); } else alert('Google indispon√≠vel'); }
        catch(e){ alert(e && e.message ? e.message : String(e)); }
      });
      btnApple && btnApple.addEventListener('click', async ()=>{
        try{ if(window.DSAuth && DSAuth.signInApple){ await DSAuth.signInApple(); } else alert('Apple indispon√≠vel'); }
        catch(e){ alert(e && e.message ? e.message : String(e)); }
      });
      btnPrim && btnPrim.addEventListener('click', async ()=>{
        try{
          const email = (inpEmail && inpEmail.value || '').trim();
          const pass  = (inpPass  && inpPass.value  || '').trim();
          if(!email || !pass){ alert('Preencha email e senha.'); return; }
          if(mode==='signUp'){
            const pass2 = (inpPass2 && inpPass2.value || '').trim();
            if(pass !== pass2){ alert('As senhas n√£o conferem.'); return; }
            const name = (inpName && inpName.value || '').trim() || undefined;
            if(window.DSAuth && DSAuth.signUpEmail){ await DSAuth.signUpEmail(email, pass, name); }
            else alert('Cadastro indispon√≠vel');
          }else{
            if(window.DSAuth && DSAuth.signInEmail){ await DSAuth.signInEmail(email, pass); }
            else alert('Login indispon√≠vel');
          }
        }catch(e){ alert(e && e.message ? e.message : String(e)); }
      });

      setMode('signIn');
    }catch(e){ console.warn('mountProfileInlineAuth error', e); }
  }

  // ===== Hook "Criar conta" (Home) para abrir popup em signUp =====
  function hookHomeCreateOpensPopup(){
    try{
      document.querySelectorAll('button, a').forEach(b=>{
        const t = (b.textContent||'').trim().toLowerCase();
        if(t === 'criar conta'){
          b.addEventListener('click', (ev)=>{
            try{
              if(window.openAuthModal){ ev.preventDefault(); window.openAuthModal('signUp'); }
            }catch(_){}
          }, {once:true});
        }
      });
    }catch(e){ console.warn('hookHomeCreateOpensPopup', e); }
  }

  // ===== Inject SMS flow into popup =====
  function injectSmsIntoPopup(){
    const backdrop = document.getElementById('authModalBackdrop') || document.querySelector('.auth-modal-backdrop');
    if(!backdrop) return;
    const body = backdrop.querySelector('.auth-body') || backdrop;
    if(!body) return;
    if (body.querySelector('#authPhone')) return; // already injected

    const sep = body.querySelector('.auth-sep') || body.lastElementChild;
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div class="auth-field">
        <label style="font-size:12px;opacity:.85">Telefone (SMS)</label>
        <input class="auth-input" id="authPhone" placeholder="+55 11 99999-9999" autocomplete="tel" />
      </div>
      <div class="auth-primary">
        <button class="auth-btn" data-auth-sms-send>Enviar c√≥digo</button>
      </div>
      <div class="auth-field" id="smsCodeWrap" style="display:none">
        <label style="font-size:12px;opacity:.85">C√≥digo SMS</label>
        <input class="auth-input" id="authSmsCode" inputmode="numeric" placeholder="123456" />
      </div>
      <div class="auth-primary" id="smsConfirmWrap" style="display:none">
        <button class="auth-btn" data-auth-sms-verify>Confirmar c√≥digo</button>
      </div>
      <div id="recaptcha-container" style="display:none"></div>
    `;
    body.insertBefore(wrap, sep);

    // Handlers
    let recaptcha = null, smsConfirm = null;
    const inputPhone  = body.querySelector('#authPhone');
    const codeWrap    = body.querySelector('#smsCodeWrap');
    const confWrap    = body.querySelector('#smsConfirmWrap');
    const inputCode   = body.querySelector('#authSmsCode');
    const btnSend     = body.querySelector('[data-auth-sms-send]');
    const btnVerify   = body.querySelector('[data-auth-sms-verify]');

    function toE164(v){
      v = (v||'').trim().replace(/[\s\-\(\)]/g, '');
      if(v.startsWith('+')) return v;
      if(/^\d+$/.test(v)){
        if(v.startsWith('55')) return '+'+v;
        return '+55'+v;
      }
      return v;
    }
    async function ensureRecaptcha(){
      if(recaptcha) return recaptcha;
      if(!window.firebase || !firebase.auth) throw new Error('Firebase Auth n√£o dispon√≠vel');
      recaptcha = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size:'invisible' });
      return recaptcha;
    }
    btnSend && btnSend.addEventListener('click', async ()=>{
      try{
        const phone = toE164(inputPhone && inputPhone.value);
        if(!phone){ alert('Informe o telefone com DDD.'); return; }
        const verifier = await ensureRecaptcha();
        smsConfirm = await firebase.auth().signInWithPhoneNumber(phone, verifier);
        if(codeWrap) codeWrap.style.display='grid';
        if(confWrap) confWrap.style.display='flex';
        alert('C√≥digo SMS enviado.');
      }catch(e){
        console.warn(e);
        alert(e && e.message ? e.message : 'Falha ao enviar SMS.');
        try{ const rid = await recaptcha.render(); if(window.grecaptcha && rid) window.grecaptcha.reset(rid); }catch(_){}
      }
    });
    btnVerify && btnVerify.addEventListener('click', async ()=>{
      try{
        const code = (inputCode && inputCode.value || '').trim();
        if(!code){ alert('Digite o c√≥digo.'); return; }
        await smsConfirm.confirm(code);
        if(window.closeAuthModal) window.closeAuthModal();
      }catch(e){ alert(e && e.message ? e.message : 'C√≥digo inv√°lido.'); }
    });
  }

  // Observe and apply when DOM changes
  const mo = new MutationObserver(()=>{
    try{
      mountProfileInlineAuth();
      hookHomeCreateOpensPopup();
      injectSmsIntoPopup();
    }catch(_){}
  });
  mo.observe(document.documentElement, {subtree:true, childList:true});
  // Run once
  try{ mountProfileInlineAuth(); hookHomeCreateOpensPopup(); injectSmsIntoPopup(); }catch(_){}
})();
</script>

</body></html>